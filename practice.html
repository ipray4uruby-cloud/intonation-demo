<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë¬¸ì¥ ì–µì–‘ ì—°ìŠµ ëª¨ë“œ</title>
<style>
  :root { --fg:#111; --muted:#666; --accent:#0a74da; }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
    margin:16px;
    color:var(--fg);
    background:#fafafa;
  }
  h1{font-size:20px;margin:0 0 4px}
  h2{font-size:16px;margin:16px 0 8px}
  p{margin:4px 0}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0}
  .sent-buttons{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin:8px 0 4px;
  }
  button{
    padding:8px 12px;
    border:1px solid #ccc;
    border-radius:999px;
    background:#fff;
    cursor:pointer;
    font-size:14px;
  }
  button[disabled]{opacity:.5;cursor:not-allowed}
  .sent-btn.active{
    border-color:var(--accent);
    color:var(--accent);
    background:#e9f3ff;
    font-weight:600;
  }
  label{font-size:13px;color:var(--muted);}
  input[type=number]{width:70px;font-size:13px;padding:2px 4px;margin-left:4px;}
  #c{
    width:100%;
    height:260px;
    border:1px solid #e2e2e2;
    border-radius:12px;
    background:#fff;
  }
  #status{color:var(--muted);font-size:13px;}
  .legend{
    display:flex;
    gap:12px;
    align-items:center;
    font-size:13px;
    color:var(--muted);
    margin-top:4px;
  }
  .legend span.dot{
    display:inline-block;
    width:10px;
    height:10px;
    border-radius:50%;
    margin-right:4px;
  }
</style>

<h1>ğŸ§ ë¬¸ì¥ ì–µì–‘ ì—°ìŠµ ëª¨ë“œ</h1>
<p style="font-size:13px;color:#555;">
  ë¬¸ì¥ì„ ì„ íƒí•œ ë’¤ ëª¨ë²” ì–µì–‘ì„ ë“£ê³ , ì§ì ‘ ë”°ë¼ ë§í•´ ë³´ì„¸ìš”.<br/>
  íšŒìƒ‰ ê³¡ì„ ì€ ëª¨ë²” ì–µì–‘, í•˜ëŠ˜ìƒ‰ ê³¡ì„ ì€ ë‚˜ì˜ ì–µì–‘ì…ë‹ˆë‹¤.
</p>

<h2>1ï¸âƒ£ ë¬¸ì¥ ì„ íƒ</h2>
<div class="sent-buttons">
  <!-- ì–´ë”” ê°€ìš”? -->
  <button class="sent-btn" data-sent="eodi_yn">ì–´ë”” ê°€ìš”? (Y/N)</button>
  <button class="sent-btn" data-sent="eodi_wh">ì–´ë”” ê°€ìš”? (WH)</button>
  <!-- ëˆ„êµ¬ ë§Œë‚˜ìš”? -->
  <button class="sent-btn" data-sent="nugu_yn">ëˆ„êµ¬ ë§Œë‚˜ìš”? (Y/N)</button>
  <button class="sent-btn" data-sent="nugu_wh">ëˆ„êµ¬ ë§Œë‚˜ìš”? (WH)</button>
  <!-- ë­ ë¨¹ì„ë˜ìš”? -->
  <button class="sent-btn" data-sent="mwo_yn">ë­ ë¨¹ì„ë˜ìš”? (Y/N)</button>
  <button class="sent-btn" data-sent="mwo_wh">ë­ ë¨¹ì„ë˜ìš”? (WH)</button>
  <!-- ì–¸ì œ ë§Œë‚ ë˜ìš”? -->
  <button class="sent-btn" data-sent="eonje_yn">ì–¸ì œ ë§Œë‚ ë˜ìš”? (Y/N)</button>
  <button class="sent-btn" data-sent="eonje_wh">ì–¸ì œ ë§Œë‚ ë˜ìš”? (WH)</button>
</div>
<p id="current-sent" style="font-size:13px;color:#333;">í˜„ì¬ ì„ íƒëœ ë¬¸ì¥: ì—†ìŒ</p>

<h2>2ï¸âƒ£ ëª¨ë²” ì–µì–‘ ë“£ê¸° & ë”°ë¼ ë§í•˜ê¸°</h2>
<div class="row">
  <button id="btn-play-model" disabled>ëª¨ë²” ì–µì–‘ ë“£ê¸°</button>
  <button id="btn-prac-start" disabled>ì—°ìŠµ ë…¹ìŒ Start</button>
  <button id="btn-prac-stop"  disabled>ì—°ìŠµ ë…¹ìŒ Stop</button>
  <span id="now" style="font-size:13px;color:#333;">í˜„ì¬ F0: -- Hz</span>
</div>
<div class="row" style="display:none">
  <label>Floor(Hz)
    <input id="floor" type="number" value="75" min="40" max="200">
  </label>
  <label>Ceiling(Hz)
    <input id="ceil" type="number" value="600" min="200" max="800">
  </label>
  <label>Smoothing
    <input id="smooth" type="number" value="5" min="1" max="21" step="2">
  </label>
</div>

<canvas id="c" width="1200" height="260"></canvas>
<div class="legend">
  <span><span class="dot" style="background:#888;"></span>ëª¨ë²” ì–µì–‘</span>
  <span><span class="dot" style="background:#0a74da;"></span>ë‚˜ì˜ ì–µì–‘</span>
  <span id="status"></span>
</div>

 <!-- ì‹¤ì‹œê°„ F0 ëª¨ë“œë¡œ ì´ë™ ë§í¬ -->
<div class="row" style="margin-top:12px;">
  <button onclick="window.location.href='index.html'">
    ì‹¤ì‹œê°„ ì–µì–‘(F0) ìµœì¢… ì œì¶œë¡œ ì´ë™
  </button>
</div> 
  
<script>
// ========================= ê³µí†µ ì„¤ì • =========================
const FRAME_MS = 30;
const HOP_MS   = 17;

const c = document.getElementById('c');
const g = c.getContext('2d');
const floorInput  = document.getElementById('floor');
const ceilInput   = document.getElementById('ceil');
const smoothInput = document.getElementById('smooth');
const nowEl       = document.getElementById('now');
const statusEl    = document.getElementById('status');

function setStatus(msg){ statusEl.textContent = " Â· " + msg; }

// ===== ì˜¤ë””ì˜¤ ë¶„ì„ìš© AudioContext (indexì™€ ë™ì¼ ê³„ì—´) =====
let audioCtx = null;
async function ensureAudioContext(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === "suspended"){
    try { await audioCtx.resume(); } catch(e){}
  }
  return audioCtx;
}

// ===== Pitch tracking í•¨ìˆ˜ (indexì™€ ë™ì¼ ê³„ì—´) =====
function hannWindow(N){
  const w = new Float32Array(N);
  for(let i=0;i<N;i++) w[i] = 0.5 - 0.5*Math.cos(2*Math.PI*i/(N-1));
  return w;
}
const ACF_WINDOW = hannWindow(2048);

function f0_from_frame(buf, sr, floor, ceil){
  const N = buf.length;
  let mean=0; for(let i=0;i<N;i++) mean += buf[i]; mean/=N;
  let rms=0;
  for(let i=0;i<N;i++){
    const v = (buf[i]-mean)*ACF_WINDOW[i%ACF_WINDOW.length];
    rms += v*v;
    buf[i] = v;
  }
  rms = Math.sqrt(rms/N);
  if(rms < 0.007) return 0; // ê°ë„: indexì™€ ë™ì¼

  const minLag = Math.floor(sr/ceil);
  const maxLag = Math.floor(sr/floor);
  let bestLag=-1, best=0;

  let denom0=0; for(let i=0;i<N;i++) denom0 += buf[i]*buf[i];
  for(let lag=minLag; lag<=maxLag; lag++){
    let s=0, denom1=0;
    for(let i=0;i<N-lag;i++){
      const a=buf[i], b=buf[i+lag];
      s+=a*b; denom1+=b*b;
    }
    const nccf = (denom1>1e-9)? s/Math.sqrt(denom0*denom1) : 0;
    if(nccf > best){ best=nccf; bestLag=lag; }
  }
  if(bestLag<0 || best<0.3) return 0;

  const ac=(lag)=>{
    let s=0; for(let i=0;i<N-lag;i++) s+=buf[i]*buf[i+lag]; return s;
  };
  const c1=ac(bestLag-1), c2=ac(bestLag), c3=ac(bestLag+1);
  const denom=(c1-2*c2+c3); let shift=0;
  if(Math.abs(denom)>1e-6) shift=0.5*(c1-c3)/denom;

  return sr/(bestLag+shift);
}

function medianSmooth(arr, k=5){
  if(k<2) return arr;
  const h=Math.floor(k/2), out=new Array(arr.length);
  for(let i=0;i<arr.length;i++){
    const s=Math.max(0,i-h), e=Math.min(arr.length,i+h+1);
    const slice=arr.slice(s,e).filter(v=>v>0).sort((a,b)=>a-b);
    out[i] = slice.length ? slice[Math.floor(slice.length/2)] : 0;
  }
  return out;
}

function trackPitch(signal, sr, floor, ceil, frameMs=FRAME_MS, hopMs=HOP_MS){
  const frame = Math.round(sr*frameMs/1000),
        hop   = Math.round(sr*hopMs/1000);
  const out=[]; const buf = new Float32Array(frame);
  for (let start = 0; start + frame <= signal.length; start += hop) {
    buf.set(signal.subarray(start, start + frame));
    let f0 = f0_from_frame(buf.slice(0), sr, floor, ceil);

    // ğŸ”¹ ì²œì¥(ceil)ì— ê±°ì˜ ë¶™ì€ ë¹„ì •ìƒì ìœ¼ë¡œ ë†’ì€ ê°’ì€ ë…¸ì´ì¦ˆë¡œ ë³´ê³  ë²„ë¦¬ê¸°
    if (f0 > ceil * 0.9) {   // ì˜ˆ: ceil=600ì´ë©´ 540Hz ì´ìƒì€ 0ìœ¼ë¡œ
      f0 = 0;
    }

    out.push(f0);
  }
  return out;
}

// ========================= ê·¸ë¦¬ê¸° ê´€ë ¨ =========================
const modelPoints = []; // ëª¨ë²” ì–µì–‘ F0 ë¦¬ìŠ¤íŠ¸
const userPoints  = []; // ë‚˜ì˜ ì–µì–‘ F0 ë¦¬ìŠ¤íŠ¸

function mapF0(f,fmin,fmax){
  const clamped=Math.max(fmin,Math.min(fmax,f));
  const r=(clamped-fmin)/(fmax-fmin);
  return 244 - r*220;
}

function drawAxes(floor, ceil){
  g.clearRect(0,0,c.width,c.height);
  g.strokeStyle="#eee"; g.lineWidth=1;
  g.beginPath(); g.moveTo(48,16); g.lineTo(48,244); g.lineTo(1184,244); g.stroke();
  [floor, Math.round((floor+ceil)/2), ceil].forEach(t=>{
    const y=mapF0(t,floor,ceil);
    g.beginPath(); g.moveTo(48,y); g.lineTo(1184,y); g.stroke();
    g.fillStyle="#666"; g.font="12px system-ui"; g.fillText(t+" Hz", 8, y-2);
  });
}

function drawSeries(points, color, floor, ceil){
  if(!points.length) return;
  const visible = points;
  g.strokeStyle=color;
  g.lineWidth=2;
  g.beginPath();
  let started=false;
  const n=visible.length;
  for(let i=0;i<n;i++){
    const f0 = visible[i];
    if(f0<=0){ started=false; continue; }
    const x = 48 + (i/Math.max(n-1,1))*1136;
    const y = mapF0(f0,floor,ceil);
    if(!started){ g.moveTo(x,y); started=true; }
    else { g.lineTo(x,y); }
  }
  g.stroke();
  g.lineWidth=1;
}

function draw(){
  const floor = +floorInput.value || 75;
  const ceil  = +ceilInput.value  || 400;
  drawAxes(floor, ceil);
  // ëª¨ë²” = íšŒìƒ‰, ë‚˜ = í•˜ëŠ˜ìƒ‰
  drawSeries(modelPoints, "#888888", floor, ceil);
  drawSeries(userPoints,  "#0a74da", floor, ceil);
  requestAnimationFrame(draw);
}
requestAnimationFrame(draw);

// ========================= ë¬¸ì¥ ì •ì˜ & ëª¨ë²” F0 ë¶„ì„ =========================
const sentenceDefs = {
  "eodi_yn":  { file: "audio/eodi_yn.wav",  label: "ì–´ë”” ê°€ìš”? (íŒì • Y/N)" },
  "eodi_wh":  { file: "audio/eodi_wh.wav",  label: "ì–´ë”” ê°€ìš”? (ì„¤ëª… WH)" },
  "nugu_yn":  { file: "audio/nugu_yn.wav",  label: "ëˆ„êµ¬ ë§Œë‚˜ìš”? (íŒì • Y/N)" },
  "nugu_wh":  { file: "audio/nugu_wh.wav",  label: "ëˆ„êµ¬ ë§Œë‚˜ìš”? (ì„¤ëª… WH)" },
  "mwo_yn":   { file: "audio/mwo_yn.wav",   label: "ë­ ë¨¹ì„ë˜ìš”? (íŒì • Y/N)" },
  "mwo_wh":   { file: "audio/mwo_wh.wav",   label: "ë­ ë¨¹ì„ë˜ìš”? (ì„¤ëª… WH)" },
  "eonje_yn": { file: "audio/eonje_yn.wav", label: "ì–¸ì œ ë§Œë‚ ë˜ìš”? (íŒì • Y/N)" },
  "eonje_wh": { file: "audio/eonje_wh.wav", label: "ì–¸ì œ ë§Œë‚ ë˜ìš”? (ì„¤ëª… WH)" }
};

const sentenceBuffers = {}; // ëª¨ë²” ìŒì„± AudioBuffer ìºì‹œ
const sentBtns = document.querySelectorAll('.sent-btn');
const currentSentLabel = document.getElementById('current-sent');

let currentSentKey = null;

async function loadSentenceBuffer(key){
  if(!sentenceDefs[key]) return null;
  if(sentenceBuffers[key]) return sentenceBuffers[key];

  const def = sentenceDefs[key];
  try {
    const resp = await fetch(def.file);
    if (!resp.ok) throw new Error("íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + def.file);
    const arrayBuf = await resp.arrayBuffer();
    const tmpCtx = new (window.AudioContext || window.webkitAudioContext)();
    const buffer = await tmpCtx.decodeAudioData(arrayBuf);
    tmpCtx.close();
    sentenceBuffers[key] = buffer;
    return buffer;
  } catch(e){
    alert("ëª¨ë²” ë°œí™” íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n" + def.file);
    console.error(e);
    return null;
  }
}

async function updateModelF0(key){
  const buffer = await loadSentenceBuffer(key);
  if(!buffer) return;
  const data = buffer.getChannelData(0);
  const sr   = buffer.sampleRate;
  const floor = +floorInput.value || 75;
  const ceil  = +ceilInput.value  || 400;
  const k     = +smoothInput.value || 5;

  const f0raw = trackPitch(data, sr, floor, ceil, FRAME_MS, HOP_MS);
  const f0    = medianSmooth(f0raw, k);

  modelPoints.length = 0;
  for(let i=0;i<f0.length;i++) modelPoints.push(f0[i]);
}

// ë¬¸ì¥ ë²„íŠ¼ í´ë¦­
sentBtns.forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const key = btn.dataset.sent;
    currentSentKey = key;
    sentBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    userPoints.length = 0; // ë‚´ ê³¡ì„  ì´ˆê¸°í™”
    currentSentLabel.textContent = "í˜„ì¬ ì„ íƒëœ ë¬¸ì¥: " + (sentenceDefs[key]?.label || key);
    setStatus("ëª¨ë²” ì–µì–‘ ë¶„ì„ ì¤‘â€¦");
    await updateModelF0(key);
    setStatus("ëª¨ë²” ì–µì–‘ ë¶„ì„ ì™„ë£Œ. ëª¨ë²” ê³¡ì„ ì„ ì°¸ê³ í•´ ì—°ìŠµí•´ ë³´ì„¸ìš”.");
    btnPlayModel.disabled   = false;
    btnPracStart.disabled   = false;
    btnPracStop.disabled    = true;
  });
});

// ========================= ëª¨ë²” ì–µì–‘ ì¬ìƒ =========================
const btnPlayModel = document.getElementById('btn-play-model');
btnPlayModel.addEventListener('click', async () => {
  if (!currentSentKey) {
    alert("ë¨¼ì € ì—°ìŠµí•  ë¬¸ì¥ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
    return;
  }

  const buffer = await loadSentenceBuffer(currentSentKey);
  if (!buffer) return;

  const ctx = new (window.AudioContext || window.webkitAudioContext)();

  // â­ iOS/Safariì—ì„œ ì¬ìƒë˜ë„ë¡ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ê¹¨ìš°ê¸°
  if (ctx.state === 'suspended') {
    try {
      await ctx.resume();
    } catch (e) {
      console.error("AudioContext resume ì‹¤íŒ¨:", e);
    }
  }

  const src = ctx.createBufferSource();
  src.buffer = buffer;
  src.connect(ctx.destination);
  src.start();
  src.onended = () => ctx.close();
});

// ========================= ì—°ìŠµ ë…¹ìŒ: indexì™€ ë™ì¼í•œ Startâ€“Stop ë°©ì‹ =========================
const btnPracStart = document.getElementById('btn-prac-start');
const btnPracStop  = document.getElementById('btn-prac-stop');

let pracStream = null;
let pracRecorder = null;
let pracChunks = [];

btnPracStart.addEventListener('click', startPracticeRecording);
btnPracStop.addEventListener('click', stopPracticeRecording);

async function startPracticeRecording(){
  if(!currentSentKey){
    alert("ë¨¼ì € ì—°ìŠµí•  ë¬¸ì¥ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
    return;
  }
  if(pracRecorder) return; // ì´ë¯¸ ë…¹ìŒ ì¤‘ì´ë©´ ë¬´ì‹œ

  try {
    await ensureAudioContext(); // ëª¨ë°”ì¼ì—ì„œ user gesture í›„ resume
    pracStream = await navigator.mediaDevices.getUserMedia({
      audio: {channelCount:1, echoCancellation:false, noiseSuppression:false, autoGainControl:false}
    });
  } catch(e){
    alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\n(HTTPS í™˜ê²½ì—ì„œë§Œ ì‘ë™)");
    console.error(e);
    return;
  }

  pracChunks = [];
  const mime =
    MediaRecorder.isTypeSupported("audio/webm;codecs=opus") ? "audio/webm;codecs=opus" :
    MediaRecorder.isTypeSupported("audio/mp4")               ? "audio/mp4" :
    "";

  pracRecorder = new MediaRecorder(pracStream, mime ? { mimeType: mime } : {});
  pracRecorder.ondataavailable = (ev)=>{
    if(ev.data && ev.data.size>0) pracChunks.push(ev.data);
  };
  pracRecorder.onstart = ()=>{
    setStatus("ì—°ìŠµ ë…¹ìŒ ì¤‘â€¦ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ í•œ ë²ˆ ë§í•´ ë³´ì„¸ìš”.");
    nowEl.textContent = "í˜„ì¬ F0: -- Hz";
    userPoints.length = 0;
  };

  pracRecorder.start();
  btnPracStart.disabled = true;
  btnPracStop.disabled  = false;
}

function stopPracticeRecording(){
  if(!pracRecorder) return;

  btnPracStop.disabled = true;
  setStatus("ì—°ìŠµ ë°œí™”ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦");

  pracRecorder.onstop = async ()=>{
    try {
      const blob = new Blob(pracChunks);
      pracChunks = [];
      const arrayBuf = await blob.arrayBuffer();
      const ctx = await ensureAudioContext();
      const audioBuf = await ctx.decodeAudioData(arrayBuf.slice(0));

      const ch = audioBuf.numberOfChannels
        ? audioBuf.getChannelData(0)
        : new Float32Array(arrayBuf.byteLength/4);

      const signal = new Float32Array(ch.length);
      let peak = 0;
      for(let i=0;i<ch.length;i++){
        const v = Math.max(-1, Math.min(1, ch[i]));
        peak = Math.max(peak, Math.abs(v));
        signal[i] = v;
      }
      if(peak>0){
        const s = 1/peak;
        for(let i=0;i<signal.length;i++) signal[i]*=s;
      }

      const floorHz = +floorInput.value  || 75;
      const ceilHz  = +ceilInput.value   || 400;
      const k       = +smoothInput.value || 5;

      const f0raw = trackPitch(signal, audioBuf.sampleRate, floorHz, ceilHz, FRAME_MS, HOP_MS);
      const f0    = medianSmooth(f0raw, k);

      userPoints.length = 0;
      for(let i=0;i<f0.length;i++) userPoints.push(f0[i]);

      const last = (()=>{
        for(let i=f0.length-1;i>=0;i--){
          if(f0[i]>0) return f0[i];
        }
        return 0;
      })();
      nowEl.textContent = "í˜„ì¬ F0: " + (last ? Math.round(last) : "--") + " Hz";

      setStatus("ì—°ìŠµ ë…¹ìŒ ì™„ë£Œ. í•˜ëŠ˜ìƒ‰ ê³¡ì„ ì„ ëª¨ë²” ê³¡ì„ ê³¼ ë¹„êµí•´ ë³´ì„¸ìš”.");
    } catch(e){
      console.error(e);
      setStatus("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }

    if(pracStream){
      pracStream.getTracks().forEach(t=>t.stop());
      pracStream = null;
    }
    pracRecorder = null;
    btnPracStart.disabled = false;
  };

  pracRecorder.stop();
}
</script>
</html>
