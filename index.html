<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í•œêµ­ì–´ ì–µì–‘ ì›¹ì•± ë°ëª¨</title>
  <style>
    :root {
      --fg: #222;
      --blue: #0a74da;
      --red: #e65b5b;
      --gray: #888888;
      --border: #e5e7eb;
      --bg-soft: #f9fafb;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 16px;
      color: var(--fg);
      background: #ffffff;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px;
    }
    h2 {
      font-size: 16px;
      margin: 16px 0 8px;
    }
    h3 {
      font-size: 14px;
      margin: 8px 0 4px;
    }
    p {
      font-size: 13px;
      margin: 4px 0;
      line-height: 1.4;
    }
    .range-box {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg-soft);
      margin-bottom: 10px;
      font-size: 13px;
    }
    .range-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 4px;
    }
    label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
    }
    input[type="number"] {
      width: 80px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }
    .tabs {
      display: inline-flex;
      border-radius: 999px;
      background: #f3f4f6;
      padding: 3px;
      margin: 4px 0 8px;
    }
    .tab-btn {
      border: none;
      background: transparent;
      padding: 6px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
    }
    .tab-btn.active {
      background: var(--blue);
      color: #ffffff;
    }
    .tab-panel.hidden {
      display: none;
    }
    canvas {
      width: 100%;
      height: 260px;
      border-radius: 12px;
      border: 1px solid #dddddd;
      background: #ffffff;
      margin: 6px 0;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin: 6px 0;
    }
    button {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      cursor: pointer;
      font-size: 14px;
    }
    button.primary {
      background: var(--blue);
      border-color: var(--blue);
      color: #ffffff;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .legend {
      font-size: 12px;
      color: #4b5563;
      margin-top: 2px;
    }
    .legend span {
      margin-right: 10px;
    }
    .dot {
      display: inline-block;
      width: 9px;
      height: 9px;
      border-radius: 999px;
      margin-right: 4px;
    }
    .dot.live { background: var(--blue); }
    .dot.model { background: var(--gray); }
    .dot.user { background: var(--red); }

    .sentence-group {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      margin-bottom: 8px;
      background: #ffffff;
    }
    .sent-btn {
      margin: 2px 4px 2px 0;
      padding: 4px 10px;
      font-size: 13px;
    }
    .sent-btn.active {
      background: #111827;
      color: #ffffff;
      border-color: #111827;
    }
    @media (max-width: 600px) {
      body { margin: 12px; }
      canvas { height: 220px; }
    }
  </style>
</head>
<body>
  <h1>ğŸ¤ í•œêµ­ì–´ ì–µì–‘ ì›¹ì•± (ì‹¤ì‹œê°„ + ì—°ìŠµ)</h1>

  <div class="range-box">
    <div>F0 ë²”ìœ„ ì„¤ì • (ë‘ ëª¨ë“œ ê³µí†µ)</div>
    <div class="range-row">
      <label>Floor(Hz)
        <input id="floor" type="number" value="75" min="40" max="300" />
      </label>
      <label>Ceiling(Hz)
        <input id="ceil" type="number" value="400" min="150" max="800" />
      </label>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="live">ì‹¤ì‹œê°„ F0 ë³´ê¸°</button>
    <button class="tab-btn" data-tab="practice">ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ</button>
  </div>

  <!-- ì‹¤ì‹œê°„ ëª¨ë“œ -->
  <div id="tab-live" class="tab-panel">
    <h2>â‘  ì‹¤ì‹œê°„ ì–µì–‘(F0) ê³¡ì„ </h2>
    <canvas id="liveCanvas" width="1200" height="260"></canvas>
    <div class="legend">
      <span><span class="dot live"></span>ì‹¤ì‹œê°„ F0</span>
    </div>
    <div class="row">
      <span id="liveNow">í˜„ì¬ F0: -- Hz</span>
    </div>
    <div class="row">
      <button id="liveStart" class="primary">Start</button>
      <button id="liveStop" disabled>Stop</button>
    </div>
    <p>Start ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë¸Œë¼ìš°ì €ì˜ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•œ ë’¤ ë§ì„ í•´ ë³´ì„¸ìš”. íŒŒë€ ì„ ìœ¼ë¡œ ì‹¤ì‹œê°„ F0 ê³¡ì„ ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
  </div>

  <!-- ì—°ìŠµ ëª¨ë“œ -->
  <div id="tab-practice" class="tab-panel hidden">
    <h2>â‘¡ ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ (ëª¨ë²” ì–µì–‘ vs ë‚´ ì–µì–‘)</h2>
    <canvas id="pracCanvas" width="1200" height="260"></canvas>
    <div class="legend">
      <span><span class="dot model"></span>ëª¨ë²” ë°œí™” F0</span>
      <span><span class="dot user"></span>ë‚´ ë°œí™” F0</span>
    </div>

    <p>ì˜ë¬¸ì‚¬ë¥¼ ì„ íƒí•˜ê³ , íŒì • ì˜ë¬¸ë¬¸(Y/N)ê³¼ ì„¤ëª… ì˜ë¬¸ë¬¸(Wh)ì˜ ì–µì–‘ì„ ë¹„êµí•´ ë³´ì„¸ìš”.</p>

    <div class="sentence-group">
      <h3>ëˆ„êµ¬</h3>
      <button class="sent-btn" data-sent="nugu_yn">ëˆ„êµ¬ ë§Œë‚˜ìš”? (íŒì •)</button>
      <button class="sent-btn" data-sent="nugu_wh">ëˆ„êµ¬ ë§Œë‚˜ìš”? (ì„¤ëª…)</button>
    </div>
    <div class="sentence-group">
      <h3>ì–´ë””</h3>
      <button class="sent-btn" data-sent="eodi_yn">ì–´ë”” ê°€ìš”? (íŒì •)</button>
      <button class="sent-btn" data-sent="eodi_wh">ì–´ë”” ê°€ìš”? (ì„¤ëª…)</button>
    </div>
    <div class="sentence-group">
      <h3>ì–¸ì œ</h3>
      <button class="sent-btn" data-sent="eonje_yn">ì–¸ì œ ì™€ìš”? (íŒì •)</button>
      <button class="sent-btn" data-sent="eonje_wh">ì–¸ì œ ì™€ìš”? (ì„¤ëª…)</button>
    </div>
    <div class="sentence-group">
      <h3>ë­</h3>
      <button class="sent-btn" data-sent="mwo_yn">ë­ í•´ìš”? (íŒì •)</button>
      <button class="sent-btn" data-sent="mwo_wh">ë­ í•´ìš”? (ì„¤ëª…)</button>
    </div>

    <div class="row">
      <button id="btn-play-model">ëª¨ë²” ë°œí™” ë“£ê¸°</button>
      <button id="btn-prac-start" class="primary">ë‚´ ë°œí™” ë…¹ìŒ ì‹œì‘</button>
      <button id="btn-prac-stop" disabled>ë…¹ìŒ ì¢…ë£Œ</button>
      <button id="btn-download-f0">ë‚´ F0 ë°ì´í„° ì €ì¥ (CSV)</button>
    </div>
    <p>
      ëª¨ë²” ë°œí™” íŒŒì¼ì€ <code>/audio</code> í´ë”ì—
      <code>nugu_yn.wav, nugu_wh.wav, eodi_yn.wav, eodi_wh.wav, eonje_yn.wav, eonje_wh.wav, mwo_yn.wav, mwo_wh.wav</code>
      ì´ë¦„ìœ¼ë¡œ ë„£ì–´ ë‘ì–´ì•¼ í•©ë‹ˆë‹¤.
    </p>
  </div>

  <script>
    // ===== íƒ­ ì „í™˜ =====
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabPanels = {
      live: document.getElementById('tab-live'),
      practice: document.getElementById('tab-practice')
    };
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.tab;
        tabButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        Object.keys(tabPanels).forEach(key => {
          tabPanels[key].classList.toggle('hidden', key !== target);
        });
      });
    });

    // ===== ê³µí†µ: floor/ceil =====
    const floorInput = document.getElementById('floor');
    const ceilInput  = document.getElementById('ceil');
    function getFloor() {
      const v = Number(floorInput.value);
      return v > 0 ? v : 75;
    }
    function getCeil() {
      const v = Number(ceilInput.value);
      return v > 0 ? v : 400;
    }

    // ===== ê³µí†µ: F0 ê³„ì‚° (v1.0 ê¸°ë°˜) =====
    function autoCorrelate(buf, sr, floor, ceil) {
      const N = buf.length;
      let mean = 0;
      for (let i = 0; i < N; i++) mean += buf[i];
      mean /= N;
      for (let i = 0; i < N; i++) {
        buf[i] = (buf[i] - mean) * (0.5 - 0.5 * Math.cos(2 * Math.PI * i / (N - 1)));
      }
      let rms = 0;
      for (let i = 0; i < N; i++) rms += buf[i] * buf[i];
      rms = Math.sqrt(rms / N);
      if (rms < 0.01) return 0;

      const maxLag = Math.floor(sr / floor);
      const minLag = Math.floor(sr / ceil);

      const xcorr = (lag) => {
        let s = 0;
        for (let i = 0; i < N - lag; i++) s += buf[i] * buf[i + lag];
        return s / (N - lag);
      };

      let bestLag = -1, best = 0;
      for (let lag = minLag; lag <= maxLag; lag++) {
        const c = xcorr(lag);
        if (c > best) {
          best = c;
          bestLag = lag;
        }
      }
      if (bestLag < 0 || best < 0.1) return 0;

      const c1 = xcorr(bestLag - 1);
      const c2 = xcorr(bestLag);
      const c3 = xcorr(bestLag + 1);
      const denom = (c1 - 2 * c2 + c3);
      let shift = 0;
      if (Math.abs(denom) > 1e-6) {
        shift = 0.5 * (c1 - c3) / denom;
      }
      return sr / (bestLag + shift);
    }

    // ===== ì‹¤ì‹œê°„ ëª¨ë“œ (v1.0 ë¡œì§ ë¶„ë¦¬) =====
    const liveCanvas = document.getElementById('liveCanvas');
    const liveCtx    = liveCanvas.getContext('2d');
    const livePoints = [];
    const liveMaxPoints = 1000;
    let liveAudioCtx = null;
    let liveSource   = null;
    let liveProcessor = null;
    let liveStream   = null;
    let liveAnimId   = null;

    const liveNowEl   = document.getElementById('liveNow');
    const liveStartBtn = document.getElementById('liveStart');
    const liveStopBtn  = document.getElementById('liveStop');

    function mapF0ToYLive(f, fmin, fmax) {
      const clamped = Math.max(fmin, Math.min(fmax, f));
      const r = (clamped - fmin) / (fmax - fmin);
      return 244 - r * 220;
    }

    function drawLive() {
      liveCtx.clearRect(0, 0, liveCanvas.width, liveCanvas.height);
      const floor = getFloor();
      const ceil  = getCeil();

      // í‹€
      liveCtx.strokeStyle = '#eeeeee';
      liveCtx.beginPath();
      liveCtx.moveTo(48, 16);
      liveCtx.lineTo(48, 244);
      liveCtx.lineTo(1184, 244);
      liveCtx.stroke();

      // ê¸°ì¤€ì„ 
      [floor, (floor + ceil) / 2, ceil].forEach(t => {
        const y = mapF0ToYLive(t, floor, ceil);
        liveCtx.strokeStyle = '#eeeeee';
        liveCtx.beginPath();
        liveCtx.moveTo(48, y);
        liveCtx.lineTo(1184, y);
        liveCtx.stroke();
        liveCtx.fillStyle = '#666666';
        liveCtx.font = '12px system-ui';
        liveCtx.fillText(Math.round(t) + ' Hz', 8, y - 2);
      });

      // F0 ê³¡ì„ 
      const visible = livePoints.slice(-liveMaxPoints);
      if (visible.length > 0) {
        liveCtx.strokeStyle = '#0a74da';
        liveCtx.lineWidth = 2;
        liveCtx.beginPath();
        let started = false;
        for (let i = 0; i < visible.length; i++) {
          const f0 = visible[i];
          if (f0 <= 0) {
            started = false;
            continue;
          }
          const x = 48 + (i / Math.max(visible.length - 1, 1)) * 1136;
          const y = mapF0ToYLive(f0, floor, ceil);
          if (!started) {
            liveCtx.moveTo(x, y);
            started = true;
          } else {
            liveCtx.lineTo(x, y);
          }
        }
        liveCtx.stroke();
        liveCtx.lineWidth = 1;
      }

      liveAnimId = requestAnimationFrame(drawLive);
    }

    async function startLive() {
      if (liveAudioCtx) return;
      try {
        liveStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (e) {
        alert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
        console.error(e);
        return;
      }
      liveAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (liveAudioCtx.state === 'suspended') {
        await liveAudioCtx.resume();
      }
      liveSource = liveAudioCtx.createMediaStreamSource(liveStream);
      liveProcessor = liveAudioCtx.createScriptProcessor(2048, 1, 1);

      liveSource.connect(liveProcessor);
      liveProcessor.connect(liveAudioCtx.destination);

      liveProcessor.onaudioprocess = (e) => {
        const inbuf = e.inputBuffer.getChannelData(0);
        const tmp = new Float32Array(inbuf);
        const f0 = autoCorrelate(tmp, liveAudioCtx.sampleRate, getFloor(), getCeil());
        livePoints.push(f0 > 0 ? f0 : 0);
        if (livePoints.length > liveMaxPoints) {
          livePoints.shift();
        }
        if (f0 > 0) {
          liveNowEl.textContent = 'í˜„ì¬ F0: ' + Math.round(f0) + ' Hz';
        } else {
          liveNowEl.textContent = 'í˜„ì¬ F0: -- Hz';
        }
      };

      livePoints.length = 0;
      drawLive();
      liveStartBtn.disabled = true;
      liveStopBtn.disabled  = false;
    }

    function stopLive() {
      if (liveProcessor) {
        liveProcessor.disconnect();
        liveProcessor.onaudioprocess = null;
        liveProcessor = null;
      }
      if (liveSource) {
        liveSource.disconnect();
        liveSource = null;
      }
      if (liveStream) {
        liveStream.getTracks().forEach(t => t.stop());
        liveStream = null;
      }
      if (liveAudioCtx) {
        liveAudioCtx.close();
        liveAudioCtx = null;
      }
      if (liveAnimId) {
        cancelAnimationFrame(liveAnimId);
        liveAnimId = null;
      }
      liveStartBtn.disabled = false;
      liveStopBtn.disabled  = true;
      liveNowEl.textContent = 'í˜„ì¬ F0: -- Hz';
    }

    liveStartBtn.addEventListener('click', startLive);
    liveStopBtn.addEventListener('click', stopLive);

    // ===== ì—°ìŠµ ëª¨ë“œ: ê·¸ë˜í”„ & ë°ì´í„° =====
    const pracCanvas = document.getElementById('pracCanvas');
    const pracCtx    = pracCanvas.getContext('2d');
    const modelF0 = [];
    const userF0  = [];

    function mapF0ToYPrac(f, fmin, fmax) {
      const clamped = Math.max(fmin, Math.min(fmax, f));
      const r = (clamped - fmin) / (fmax - fmin);
      return 244 - r * 220;
    }

    function drawPractice() {
      pracCtx.clearRect(0, 0, pracCanvas.width, pracCanvas.height);
      const floor = getFloor();
      const ceil  = getCeil();

      // í‹€
      pracCtx.strokeStyle = '#eeeeee';
      pracCtx.beginPath();
      pracCtx.moveTo(48, 16);
      pracCtx.lineTo(48, 244);
      pracCtx.lineTo(1184, 244);
      pracCtx.stroke();

      // ê¸°ì¤€ì„ 
      [floor, (floor + ceil) / 2, ceil].forEach(t => {
        const y = mapF0ToYPrac(t, floor, ceil);
        pracCtx.strokeStyle = '#eeeeee';
        pracCtx.beginPath();
        pracCtx.moveTo(48, y);
        pracCtx.lineTo(1184, y);
        pracCtx.stroke();
        pracCtx.fillStyle = '#666666';
        pracCtx.font = '12px system-ui';
        pracCtx.fillText(Math.round(t) + ' Hz', 8, y - 2);
      });

      // ëª¨ë²” ë°œí™” (íšŒìƒ‰)
      const visibleModel = modelF0;
      if (visibleModel.length > 0) {
        pracCtx.strokeStyle = '#888888';
        pracCtx.lineWidth = 2;
        pracCtx.beginPath();
        let started = false;
        for (let i = 0; i < visibleModel.length; i++) {
          const f0 = visibleModel[i];
          if (f0 <= 0) {
            started = false;
            continue;
          }
          const x = 48 + (i / Math.max(visibleModel.length - 1, 1)) * 1136;
          const y = mapF0ToYPrac(f0, floor, ceil);
          if (!started) {
            pracCtx.moveTo(x, y);
            started = true;
          } else {
            pracCtx.lineTo(x, y);
          }
        }
        pracCtx.stroke();
      }

      // ë‚´ ë°œí™” (ë¹¨ê°„ìƒ‰)
      const visibleUser = userF0;
      if (visibleUser.length > 0) {
        pracCtx.strokeStyle = '#e65b5b';
        pracCtx.lineWidth = 2;
        pracCtx.beginPath();
        let started2 = false;
        for (let i = 0; i < visibleUser.length; i++) {
          const f0 = visibleUser[i];
          if (f0 <= 0) {
            started2 = false;
            continue;
          }
          const x = 48 + (i / Math.max(visibleUser.length - 1, 1)) * 1136;
          const y = mapF0ToYPrac(f0, floor, ceil);
          if (!started2) {
            pracCtx.moveTo(x, y);
            started2 = true;
          } else {
            pracCtx.lineTo(x, y);
          }
        }
        pracCtx.stroke();
      }

      pracCtx.lineWidth = 1;
    }

    // ===== ì—°ìŠµ ëª¨ë“œ: ë¬¸ì¥ ì •ì˜ ë° ëª¨ë²” F0 ì¶”ì¶œ =====
    const sentenceDefs = {
      "nugu_yn":  { file: "audio/nugu_yn.wav",  label: "ëˆ„êµ¬ ë§Œë‚˜ìš”? (íŒì •)" },
      "nugu_wh":  { file: "audio/nugu_wh.wav",  label: "ëˆ„êµ¬ ë§Œë‚˜ìš”? (ì„¤ëª…)" },
      "eodi_yn":  { file: "audio/eodi_yn.wav",  label: "ì–´ë”” ê°€ìš”? (íŒì •)" },
      "eodi_wh":  { file: "audio/eodi_wh.wav",  label: "ì–´ë”” ê°€ìš”? (ì„¤ëª…)" },
      "eonje_yn": { file: "audio/eonje_yn.wav", label: "ì–¸ì œ ì™€ìš”? (íŒì •)" },
      "eonje_wh": { file: "audio/eonje_wh.wav", label: "ì–¸ì œ ì™€ìš”? (ì„¤ëª…)" },
      "mwo_yn":   { file: "audio/mwo_yn.wav",   label: "ë­ í•´ìš”? (íŒì •)" },
      "mwo_wh":   { file: "audio/mwo_wh.wav",   label: "ë­ í•´ìš”? (ì„¤ëª…)" }
    };

    const sentenceBuffers = {};
    const sentBtns = document.querySelectorAll('.sent-btn');
    let currentSentKey = null;

    async function loadSentenceBuffer(key) {
      if (!sentenceDefs[key]) return null;
      if (sentenceBuffers[key]) return sentenceBuffers[key];
      const def = sentenceDefs[key];
      try {
        const resp = await fetch(def.file);
        if (!resp.ok) throw new Error('file not found');
        const arrayBuf = await resp.arrayBuffer();
        const tmpCtx = new (window.AudioContext || window.webkitAudioContext)();
        const buffer = await tmpCtx.decodeAudioData(arrayBuf);
        tmpCtx.close();
        sentenceBuffers[key] = buffer;
        return buffer;
      } catch (e) {
        alert('ëª¨ë²” ë°œí™” íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ' + def.file);
        console.error(e);
        return null;
      }
    }

    async function updateModelF0(key) {
      const buffer = await loadSentenceBuffer(key);
      if (!buffer) return;
      const data = buffer.getChannelData(0);
      const sr   = buffer.sampleRate;
      const size = 2048;
      const hop  = 512;
      const tmp  = new Float32Array(size);

      modelF0.length = 0;

      const floor = getFloor();
      const ceil  = getCeil();

      for (let pos = 0; pos + size < data.length; pos += hop) {
        for (let i = 0; i < size; i++) {
          tmp[i] = data[pos + i];
        }
        const f0 = autoCorrelate(new Float32Array(tmp), sr, floor, ceil);
        modelF0.push(f0 > 0 ? f0 : 0);
        if (modelF0.length > 1000) break;
      }
      drawPractice();
    }

    sentBtns.forEach(btn => {
      btn.addEventListener('click', async () => {
        const key = btn.dataset.sent;
        currentSentKey = key;
        sentBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        userF0.length = 0;
        await updateModelF0(key);
      });
    });

    // ===== ì—°ìŠµ ëª¨ë“œ: ëª¨ë²” ë°œí™” ì¬ìƒ =====
    const btnPlayModel = document.getElementById('btn-play-model');
    btnPlayModel.addEventListener('click', async () => {
      if (!currentSentKey) {
        alert('ë¨¼ì € ì—°ìŠµí•  ë¬¸ì¥ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }
      const buffer = await loadSentenceBuffer(currentSentKey);
      if (!buffer) return;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const src = ctx.createBufferSource();
      src.buffer = buffer;
      src.connect(ctx.destination);
      src.start();
      src.onended = () => ctx.close();
    });

    // ===== ì—°ìŠµ ëª¨ë“œ: ë‚´ ë°œí™” ë…¹ìŒ â†’ F0 ì¶”ì¶œ =====
    let pracAudioCtx = null;
    let pracSource   = null;
    let pracProcessor = null;
    let pracStream   = null;

    const btnPracStart = document.getElementById('btn-prac-start');
    const btnPracStop  = document.getElementById('btn-prac-stop');

    async function startPracticeRecording() {
      if (!currentSentKey) {
        alert('ë¨¼ì € ì—°ìŠµí•  ë¬¸ì¥ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }
      if (pracAudioCtx) return;
      try {
        pracStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (e) {
        alert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
        console.error(e);
        return;
      }
      pracAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (pracAudioCtx.state === 'suspended') {
        await pracAudioCtx.resume();
      }
      pracSource = pracAudioCtx.createMediaStreamSource(pracStream);
      pracProcessor = pracAudioCtx.createScriptProcessor(2048, 1, 1);

      pracSource.connect(pracProcessor);
      pracProcessor.connect(pracAudioCtx.destination);

      userF0.length = 0;

      pracProcessor.onaudioprocess = (e) => {
        const inbuf = e.inputBuffer.getChannelData(0);
        const tmp = new Float32Array(inbuf);
        const f0 = autoCorrelate(tmp, pracAudioCtx.sampleRate, getFloor(), getCeil());
        userF0.push(f0 > 0 ? f0 : 0);
        if (userF0.length > 1000) {
          userF0.shift();
        }
      };

      btnPracStart.disabled = true;
      btnPracStop.disabled  = false;
    }

    function stopPracticeRecording() {
      if (pracProcessor) {
        pracProcessor.disconnect();
        pracProcessor.onaudioprocess = null;
        pracProcessor = null;
      }
      if (pracSource) {
        pracSource.disconnect();
        pracSource = null;
      }
      if (pracStream) {
        pracStream.getTracks().forEach(t => t.stop());
        pracStream = null;
      }
      if (pracAudioCtx) {
        pracAudioCtx.close();
        pracAudioCtx = null;
      }
      btnPracStart.disabled = false;
      btnPracStop.disabled  = true;
      drawPractice();
    }

    btnPracStart.addEventListener('click', startPracticeRecording);
    btnPracStop.addEventListener('click', stopPracticeRecording);

    // ===== ì—°ìŠµ ëª¨ë“œ: ë‚´ F0 ë°ì´í„° ë‹¤ìš´ë¡œë“œ =====
    const btnDownloadF0 = document.getElementById('btn-download-f0');
    btnDownloadF0.addEventListener('click', () => {
      if (!userF0.length) {
        alert('ë¨¼ì € ë‚´ ë°œí™”ë¥¼ ë…¹ìŒí•´ì„œ F0 ê³¡ì„ ì„ ë§Œë“¤ì–´ ì£¼ì„¸ìš”.');
        return;
      }
      let csv = 'index,f0_Hz\\n';
      userF0.forEach((f0, i) => {
        csv += i + ',' + f0 + '\\n';
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'my_intonation_f0.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // ì´ˆê¸° ì—°ìŠµ ìº”ë²„ìŠ¤ ì¶•ë§Œ ê·¸ë ¤ë‘ê¸°
    drawPractice();
  </script>
</body>
</html>
