<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ïã§ÏãúÍ∞Ñ ÏñµÏñë Í≥°ÏÑ† Îç∞Î™®</title>
<style>
  :root { --fg:#222; }
  body { font-family: system-ui, sans-serif; margin:16px; color:var(--fg);}
  h1 { font-size: 18px; margin-bottom: 8px;}
  #c { width:100%; height:260px; border:1px solid #ddd; border-radius:8px;}
  .row { display:flex; flex-wrap:wrap; gap:10px; margin:10px 0; }
  button { padding:8px 12px; border:1px solid #ccc; border-radius:8px; cursor:pointer;}
  input[type=number]{width:90px;}
</style>
<h1>üé§ Ïã§ÏãúÍ∞Ñ ÏñµÏñë(F0) Í≥°ÏÑ†</h1>
<div class="row">
  <button id="start">Start</button>
  <button id="stop" disabled>Stop</button>
  <label>Floor(Hz)<input id="floor" type="number" value="75" min="40" max="200"></label>
  <label>Ceiling(Hz)<input id="ceil" type="number" value="400" min="200" max="800"></label>
</div>
<canvas id="c" width="1200" height="260"></canvas>
<div id="now">F0: -- Hz</div>
<script>
let audioCtx, source, processor, stream, animId;
const c=document.getElementById('c'), g=c.getContext('2d');
const points=[], maxPoints=1000;
function autoCorrelate(buf,sr,floor=75,ceil=400){
  const N=buf.length;
  let mean=0; for(let i=0;i<N;i++) mean+=buf[i]; mean/=N;
  for(let i=0;i<N;i++) buf[i]=(buf[i]-mean)*(0.5-0.5*Math.cos(2*Math.PI*i/(N-1)));
  const maxLag=Math.floor(sr/floor), minLag=Math.floor(sr/ceil);
  let rms=0; for(let i=0;i<N;i++) rms+=buf[i]*buf[i]; rms=Math.sqrt(rms/N);
  if(rms<0.01) return 0;
  const xcorr=(lag)=>{let s=0;for(let i=0;i<N-lag;i++) s+=buf[i]*buf[i+lag];return s/(N-lag);}
  let bestLag=-1,best=0;
  for(let lag=minLag;lag<=maxLag;lag++){const c=xcorr(lag);if(c>best){best=c;bestLag=lag;}}
  if(bestLag<0||best<0.1) return 0;
  const c1=xcorr(bestLag-1), c2=xcorr(bestLag), c3=xcorr(bestLag+1);
  const denom=(c1-2*c2+c3); let shift=0;
  if(Math.abs(denom)>1e-6) shift=0.5*(c1-c3)/denom;
  return sr/(bestLag+shift);
}
function draw(){
  g.clearRect(0,0,c.width,c.height);
  g.strokeStyle="#eee"; g.beginPath(); g.moveTo(48,16); g.lineTo(48,244); g.lineTo(1184,244); g.stroke();
  const floor=+document.getElementById('floor').value, ceil=+document.getElementById('ceil').value;
  [floor,(floor+ceil)/2,ceil].forEach(t=>{
    const y=mapF0(t,floor,ceil);
    g.strokeStyle="#eee"; g.beginPath(); g.moveTo(48,y); g.lineTo(1184,y); g.stroke();
    g.fillStyle="#666"; g.font="12px system-ui"; g.fillText(Math.round(t)+" Hz",8,y-2);
  });
  g.strokeStyle="#0a74da"; g.beginPath();
  const visible=points.slice(-maxPoints); let started=false;
  for(let i=0;i<visible.length;i++){
    const f0=visible[i]; if(f0<=0){started=false;continue;}
    const x=48+(i/Math.max(visible.length-1,1))*1136;
    const y=mapF0(f0,floor,ceil);
    if(!started){g.moveTo(x,y);started=true;}else{g.lineTo(x,y);}
  }
  g.stroke();
  animId=requestAnimationFrame(draw);
  function mapF0(f,fmin,fmax){const clamped=Math.max(fmin,Math.min(fmax,f));const r=(clamped-fmin)/(fmax-fmin);return 244 - r*220;}
}
async function start(){
  try{stream=await navigator.mediaDevices.getUserMedia({audio:true});}
  catch(e){alert("ÎßàÏù¥ÌÅ¨ Í∂åÌïú ÌïÑÏöî!");return;}
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  source=audioCtx.createMediaStreamSource(stream);
  processor=audioCtx.createScriptProcessor(2048,1,1);
  source.connect(processor); processor.connect(audioCtx.destination);
  processor.onaudioprocess=(e)=>{
    const inbuf=e.inputBuffer.getChannelData(0);
    const f0=autoCorrelate(new Float32Array(inbuf),audioCtx.sampleRate,+floor.value,+ceil.value);
    points.push(f0>0?f0:0); if(points.length>5000) points.shift();
    document.getElementById('now').textContent="F0: "+(f0?Math.round(f0):"--")+" Hz";
  };
  draw(); startBtn.disabled=true; stopBtn.disabled=false;
}
function stop(){
  if(processor){processor.disconnect();processor.onaudioprocess=null;}
  if(source) source.disconnect();
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
  if(audioCtx){audioCtx.close();audioCtx=null;}
  if(animId){cancelAnimationFrame(animId);animId=null;}
  startBtn.disabled=false; stopBtn.disabled=true;
}
const startBtn=document.getElementById('start'), stopBtn=document.getElementById('stop');
startBtn.onclick=start; stopBtn.onclick=stop;
</script>
</html>
