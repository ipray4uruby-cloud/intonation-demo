<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì‹¤ì‹œê°„ ì–µì–‘(ê°€ë¡œ ìŠ¤í¬ë¡¤ ë²„ì „)</title>
<style>
  :root { --fg:#111; --muted:#666; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; margin:16px; color:var(--fg);}
  h1{font-size:18px;margin:0 0 8px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0}
  button{padding:9px 14px;border:1px solid #ccc;border-radius:10px;background:#fafafa;cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  input[type=number]{width:86px}
  
  /* ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ë˜í¼ ìŠ¤íƒ€ì¼: ê·¸ë˜í”„ê°€ ê¸¸ì–´ì§€ë©´ ê°€ë¡œ ìŠ¤í¬ë¡¤ ìƒì„± */
  .canvas-wrapper {
    width: 100%;
    overflow-x: auto;
    border: 1px solid #e2e2e2;
    border-radius: 12px;
    background: #fff;
    margin-bottom: 10px;
  }
  
  /* ìº”ë²„ìŠ¤ëŠ” blockìœ¼ë¡œ ì„¤ì •í•˜ì—¬ í•˜ë‹¨ ì—¬ë°± ì œê±° */
  #c {
    display: block;
  }

  #status{color:var(--muted)}
</style>
</head>
<body>

<h1>ğŸ¤ STARTâ€“STOP í›„ ì „ì²´ ì–µì–‘ (ê°€ë¡œ ìŠ¤í¬ë¡¤)</h1>
<div class="row">
  <button id="start">Start</button>
  <button id="stop" disabled>Stop</button>
  <button id="reset" disabled>Reset</button>
  <label>Floor(Hz) <input id="floor" type="number" value="75" min="40" max="200"></label>
  <label>Ceiling(Hz) <input id="ceil" type="number" value="400" min="200" max="800"></label>
  <label>Smoothing <input id="smooth" type="number" value="5" min="1" max="21" step="2"></label>
</div>

<div class="canvas-wrapper">
  <canvas id="c" width="1200" height="260"></canvas>
</div>

<div class="row"><div id="now">F0: -- Hz</div><small id="status">ì¤€ë¹„ ì™„ë£Œ</small></div>

<script>
let mediaStream, mediaRecorder, chunks=[], audioCtx;
const startBtn = document.getElementById('start');
const stopBtn  = document.getElementById('stop');
const resetBtn = document.getElementById('reset');
const c = document.getElementById('c'), g = c.getContext('2d');

function setStatus(t){ document.getElementById('status').textContent = " Â· " + t; }

async function ensureAudioContext(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === 'suspended') { try{ await audioCtx.resume(); }catch(e){} }
  return audioCtx;
}

// ===== Pitch tracking (autocorrelation) =====
function hannWindow(N){ const w=new Float32Array(N); for(let i=0;i<N;i++) w[i]=0.5-0.5*Math.cos(2*Math.PI*i/(N-1)); return w; }
const ACF_WINDOW = hannWindow(2048);

function f0_from_frame(buf, sr, floor, ceil){
  // center-clip + AC
  const N = buf.length;
  let mean=0; for(let i=0;i<N;i++) mean += buf[i]; mean/=N;
  let rms=0; for(let i=0;i<N;i++){ const v=(buf[i]-mean)*ACF_WINDOW[i%ACF_WINDOW.length]; rms+=v*v; buf[i]=v; }
  rms = Math.sqrt(rms/N);
  if(rms < 0.005) return 0;

  const minLag = Math.floor(sr/ceil);
  const maxLag = Math.floor(sr/floor);
  let bestLag=-1, best=0;

  // normalized autocorrelation
  let denom0=0; for(let i=0;i<N;i++) denom0 += buf[i]*buf[i];
  for(let lag=minLag; lag<=maxLag; lag++){
    let s=0, denom1=0;
    for(let i=0;i<N-lag;i++){ const a=buf[i], b=buf[i+lag]; s+=a*b; denom1+=b*b; }
    const nccf = (denom1>1e-9)? s/Math.sqrt(denom0*denom1) : 0;
    if(nccf > best){ best=nccf; bestLag=lag; }
  }
  if(bestLag<0 || best<0.3) return 0;

  // parabolic interpolation around bestLag
  const ac=(lag)=>{
    let s=0; for(let i=0;i<N-lag;i++) s+=buf[i]*buf[i+lag]; return s;
  }
  const c1=ac(bestLag-1), c2=ac(bestLag), c3=ac(bestLag+1);
  const denom=(c1-2*c2+c3); let shift=0;
  if(Math.abs(denom)>1e-6) shift=0.5*(c1-c3)/denom;

  return sr/(bestLag+shift);
}

function medianSmooth(arr, k=5){
  if(k<2) return arr;
  const h=Math.floor(k/2), out=new Array(arr.length);
  for(let i=0;i<arr.length;i++){
    const s=Math.max(0,i-h), e=Math.min(arr.length,i+h+1);
    const slice=arr.slice(s,e).filter(v=>v>0).sort((a,b)=>a-b);
    out[i] = slice.length ? slice[Math.floor(slice.length/2)] : 0;
  }
  return out;
}

function trackPitch(signal, sr, floor, ceil, frameMs=30, hopMs=10){
  const frame = Math.round(sr*frameMs/1000), hop = Math.round(sr*hopMs/1000);
  const out=[]; const buf = new Float32Array(frame);
  for(let start=0; start+frame<=signal.length; start+=hop){
    buf.set(signal.subarray(start,start+frame));
    out.push(f0_from_frame(buf.slice(0), sr, floor, ceil));
  }
  return out;
}

function mapF0(f,fmin,fmax){ const clamped=Math.max(fmin,Math.min(fmax,f)); const r=(clamped-fmin)/(fmax-fmin); return 244 - r*220; }

// ===== Drawing (ìˆ˜ì •ë¨: ê°€ë³€ ë„ˆë¹„ ëŒ€ì‘) =====

function drawAxes(floor, ceil){
  g.clearRect(0,0,c.width,c.height);
  
  // ìº”ë²„ìŠ¤ ë„ˆë¹„ì— ë§ì¶°ì„œ ë°°ê²½ì„  ê·¸ë¦¬ê¸°
  const W = c.width - 16; 

  g.strokeStyle="#eee"; g.lineWidth=1;
  g.beginPath(); g.moveTo(48,16); g.lineTo(48,244); g.lineTo(W,244); g.stroke();
  
  [floor, Math.round((floor+ceil)/2), ceil].forEach(t=>{
    const y=mapF0(t,floor,ceil);
    g.beginPath(); g.moveTo(48,y); g.lineTo(W,y); g.stroke();
    g.fillStyle="#666"; g.font="12px system-ui"; g.fillText(t+" Hz", 8, y-2);
  });
}

function drawContour(f0s, floor, ceil, color="#0a74da"){
  // [ì„¤ì •] ì  í•˜ë‚˜ë‹¹ ëª‡ í”½ì…€ì„ ì°¨ì§€í• ì§€ ê²°ì • (ê¸°ë³¸ê°’: 5)
  // ì´ ê°’ì´ í´ìˆ˜ë¡ ê·¸ë˜í”„ê°€ ê°€ë¡œë¡œ ë” ê¸¸ê²Œ ëŠ˜ì–´ë‚©ë‹ˆë‹¤.
  const pxPerPoint = 5; 

  // ë°ì´í„° ê¸¸ì´ì— ë§ì¶° ìº”ë²„ìŠ¤ í­ì„ ê³„ì‚° ë° ë³€ê²½ (ìµœì†Œ 1200px)
  const neededWidth = 48 + (f0s.length * pxPerPoint) + 100;
  c.width = Math.max(1200, neededWidth);

  // ìº”ë²„ìŠ¤ í¬ê¸°ê°€ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ ë°°ê²½ì„ ë‹¤ì‹œ ê·¸ë¦¼
  drawAxes(floor, ceil);

  const n=f0s.length;
  g.strokeStyle=color; g.lineWidth=2; g.beginPath();
  let started=false;
  
  for(let i=0;i<n;i++){
    const f0=f0s[i]; if(f0<=0){ started=false; continue; }
    
    // xì¢Œí‘œ: ê³ ì • ê°„ê²©(pxPerPoint)ìœ¼ë¡œ ë°°ì¹˜
    const x = 48 + i * pxPerPoint;
    const y = mapF0(f0, floor, ceil);
    
    if(!started){ g.moveTo(x,y); started=true; } else { g.lineTo(x,y); }
  }
  g.stroke();
}


// ===== UI flow =====
startBtn.onclick = async () => {
  try{
    await ensureAudioContext(); 
    mediaStream = await navigator.mediaDevices.getUserMedia({
      audio: {channelCount:1, echoCancellation:false, noiseSuppression:false, autoGainControl:false}
    });
  }catch(e){
    alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\n(HTTPS í™˜ê²½ì—ì„œë§Œ ì‘ë™)");
    return;
  }
  chunks.length = 0;
  const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus'
               : MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4'
               : '';
  mediaRecorder = new MediaRecorder(mediaStream, mime?{mimeType:mime}:{});
  mediaRecorder.ondataavailable = (ev)=>{ if(ev.data && ev.data.size>0) chunks.push(ev.data); };
  mediaRecorder.onstart = ()=> setStatus("ë…¹ìŒ ì¤‘â€¦ ë¬¸ì¥ì„ ë§í•˜ì„¸ìš”.");
  mediaRecorder.start();

  startBtn.disabled = true; stopBtn.disabled = false; resetBtn.disabled = true;
  
  // ì‹œì‘ ì‹œ ìº”ë²„ìŠ¤ í¬ê¸° ì´ˆê¸°í™”
  c.width = 1200;
  drawAxes(+floor.value, +ceil.value);
  document.getElementById('now').textContent = "F0: -- Hz";
};

stopBtn.onclick = async () => {
  stopBtn.disabled = true;
  if(!mediaRecorder){ return; }
  setStatus("ì²˜ë¦¬ ì¤‘â€¦(1ì´ˆ ë‚´)");
  mediaRecorder.onstop = async ()=>{
    const blob = new Blob(chunks);
    chunks.length = 0;

    const arrayBuf = await blob.arrayBuffer();
    const ctx = await ensureAudioContext();
    const audioBuf = await ctx.decodeAudioData(arrayBuf.slice(0));

    const ch = audioBuf.numberOfChannels ? audioBuf.getChannelData(0) : new Float32Array(arrayBuf.byteLength/4);
    const signal = new Float32Array(ch.length);
    let peak = 0; for(let i=0;i<ch.length;i++){ const v=Math.max(-1,Math.min(1,ch[i])); peak=Math.max(peak,Math.abs(v)); signal[i]=v; }
    if(peak>0){ const s=1/peak; for(let i=0;i<signal.length;i++) signal[i]*=s; }

    const floorHz = +document.getElementById('floor').value || 75;
    const ceilHz  = +document.getElementById('ceil').value  || 400;
    const f0sRaw  = trackPitch(signal, audioBuf.sampleRate, floorHz, ceilHz, 30, 10);
    const k = +document.getElementById('smooth').value;
    const f0s = medianSmooth(f0sRaw, k);

    const last = f0s.findLast ? (f0s.findLast(v=>v>0)||0) : (function(){ for(let i=f0s.length-1;i>=0;i--) if(f0s[i]>0) return f0s[i]; return 0; })();
    document.getElementById('now').textContent = "F0: " + (last? Math.round(last) : "--") + " Hz";

    drawContour(f0s, floorHz, ceilHz);
    setStatus("ì™„ë£Œ. ë‹¤ì‹œ ë…¹ìŒí•˜ë ¤ë©´ Reset â†’ Start");
    resetBtn.disabled = false;
  };
  mediaRecorder.stop();
  if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
};

resetBtn.onclick = ()=>{
  // ì´ˆê¸°í™” ì‹œ ìº”ë²„ìŠ¤ í¬ê¸° ë° ê·¸ë¦¬ê¸° ë³µêµ¬
  c.width = 1200;
  drawAxes(+floor.value, +ceil.value);
  document.getElementById('now').textContent = "F0: -- Hz";
  setStatus("ì¤€ë¹„ ì™„ë£Œ");
  startBtn.disabled=false; stopBtn.disabled=true; resetBtn.disabled=true;
};

// ì´ˆê¸° ì¶• ê·¸ë¦¬ê¸°
drawAxes(+floor.value, +ceil.value);
</script>
</body>
</html>
