<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ïã§ÏãúÍ∞Ñ ÏñµÏñë(START‚ÄìSTOP ÌõÑ Ï†ÑÏ≤¥ Î∂ÑÏÑù)</title>
<style>
  :root { --fg:#111; --muted:#666; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; margin:16px; color:var(--fg);}
  h1{font-size:18px;margin:0 0 8px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0}
  button{padding:9px 14px;border:1px solid #ccc;border-radius:10px;background:#fafafa;cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  input[type=number]{width:86px}
  #c{width:100%;height:260px;border:1px solid #e2e2e2;border-radius:12px;background:#fff}
  #status{color:var(--muted)}
</style>

<h1>üé§ START‚ÄìSTOP ÌõÑ Ï†ÑÏ≤¥ ÏñµÏñë(F0) Í≥°ÏÑ†</h1>
<div class="row">
  <button id="start">Start</button>
  <button id="stop" disabled>Stop</button>
  <button id="reset" disabled>Reset</button>
  <label>Floor(Hz) <input id="floor" type="number" value="75" min="40" max="200"></label>
  <label>Ceiling(Hz) <input id="ceil" type="number" value="400" min="200" max="800"></label>
  <label>Smoothing <input id="smooth" type="number" value="5" min="1" max="21" step="2"></label>
</div>
<canvas id="c" width="1200" height="260"></canvas>
<div class="row"><div id="now">F0: -- Hz</div><small id="status">Ï§ÄÎπÑ ÏôÑÎ£å</small></div>

<script>
let mediaStream, mediaRecorder, chunks=[], audioCtx;
const startBtn = document.getElementById('start');
const stopBtn  = document.getElementById('stop');
const resetBtn = document.getElementById('reset');
const c = document.getElementById('c'), g = c.getContext('2d');

function setStatus(t){ document.getElementById('status').textContent = " ¬∑ " + t; }

async function ensureAudioContext(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === 'suspended') { try{ await audioCtx.resume(); }catch(e){} }
  return audioCtx;
}

// ===== Pitch tracking (autocorrelation) =====
function hannWindow(N){ const w=new Float32Array(N); for(let i=0;i<N;i++) w[i]=0.5-0.5*Math.cos(2*Math.PI*i/(N-1)); return w; }
const ACF_WINDOW = hannWindow(2048);

function f0_from_frame(buf, sr, floor, ceil){
  // center-clip + AC
  const N = buf.length;
  let mean=0; for(let i=0;i<N;i++) mean += buf[i]; mean/=N;
  let rms=0; for(let i=0;i<N;i++){ const v=(buf[i]-mean)*ACF_WINDOW[i%ACF_WINDOW.length]; rms+=v*v; buf[i]=v; }
  rms = Math.sqrt(rms/N);
  if(rms < 0.005) return 0;

  const minLag = Math.floor(sr/ceil);
  const maxLag = Math.floor(sr/floor);
  let bestLag=-1, best=0;

  // normalized autocorrelation
  let denom0=0; for(let i=0;i<N;i++) denom0 += buf[i]*buf[i];
  for(let lag=minLag; lag<=maxLag; lag++){
    let s=0, denom1=0;
    for(let i=0;i<N-lag;i++){ const a=buf[i], b=buf[i+lag]; s+=a*b; denom1+=b*b; }
    const nccf = (denom1>1e-9)? s/Math.sqrt(denom0*denom1) : 0;
    if(nccf > best){ best=nccf; bestLag=lag; }
  }
  if(bestLag<0 || best<0.3) return 0;

  // parabolic interpolation around bestLag
  const ac=(lag)=>{
    let s=0; for(let i=0;i<N-lag;i++) s+=buf[i]*buf[i+lag]; return s;
  }
  const c1=ac(bestLag-1), c2=ac(bestLag), c3=ac(bestLag+1);
  const denom=(c1-2*c2+c3); let shift=0;
  if(Math.abs(denom)>1e-6) shift=0.5*(c1-c3)/denom;

  return sr/(bestLag+shift);
}

function medianSmooth(arr, k=5){
  if(k<2) return arr;
  const h=Math.floor(k/2), out=new Array(arr.length);
  for(let i=0;i<arr.length;i++){
    const s=Math.max(0,i-h), e=Math.min(arr.length,i+h+1);
    const slice=arr.slice(s,e).filter(v=>v>0).sort((a,b)=>a-b);
    out[i] = slice.length ? slice[Math.floor(slice.length/2)] : 0;
  }
  return out;
}

function trackPitch(signal, sr, floor, ceil, frameMs=30, hopMs=17){ // ‚òÖ hopMs Í∏∞Î≥∏Í∞í 20ms
  const frame = Math.round(sr*frameMs/1000), hop = Math.round(sr*hopMs/1000);
  const out=[]; const buf = new Float32Array(frame);
  for(let start=0; start+frame<=signal.length; start+=hop){
    buf.set(signal.subarray(start,start+frame));
    out.push(f0_from_frame(buf.slice(0), sr, floor, ceil));
  }
  return out;
}

// ===== Drawing =====
function drawAxes(floor, ceil){
  g.clearRect(0,0,c.width,c.height);
  g.strokeStyle="#eee"; g.lineWidth=1;
  g.beginPath(); g.moveTo(48,16); g.lineTo(48,244); g.lineTo(1184,244); g.stroke();
  [floor, Math.round((floor+ceil)/2), ceil].forEach(t=>{
    const y=mapF0(t,floor,ceil);
    g.beginPath(); g.moveTo(48,y); g.lineTo(1184,y); g.stroke();
    g.fillStyle="#666"; g.font="12px system-ui"; g.fillText(t+" Hz", 8, y-2);
  });
}

function drawContour(f0s, floor, ceil, color="#0a74da"){
  drawAxes(floor, ceil);
  const n=f0s.length;
  g.strokeStyle=color; g.lineWidth=2; g.beginPath();
  let started=false;
  for(let i=0;i<n;i++){
    const f0=f0s[i]; if(f0<=0){ started=false; continue; }
    const x=48 + (i/Math.max(n-1,1))*1136;
    const y=mapF0(f0,floor,ceil);
    if(!started){ g.moveTo(x,y); started=true; } else { g.lineTo(x,y); }
  }
  g.stroke();
}
function mapF0(f,fmin,fmax){ const clamped=Math.max(fmin,Math.min(fmax,f)); const r=(clamped-fmin)/(fmax-fmin); return 244 - r*220; }

// ===== UI flow =====
startBtn.onclick = async () => {
  try{
    await ensureAudioContext(); // Î™®Î∞îÏùºÏóêÏÑú user gesture ÌõÑ resume
    mediaStream = await navigator.mediaDevices.getUserMedia({
      audio: {channelCount:1, echoCancellation:false, noiseSuppression:false, autoGainControl:false}
    });
  }catch(e){
    alert("ÎßàÏù¥ÌÅ¨ Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.\n(HTTPS ÌôòÍ≤ΩÏóêÏÑúÎßå ÏûëÎèô)");
    return;
  }
  chunks.length = 0;
  const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus'
               : MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4'
               : '';
  mediaRecorder = new MediaRecorder(mediaStream, mime?{mimeType:mime}:{});
  mediaRecorder.ondataavailable = (ev)=>{ if(ev.data && ev.data.size>0) chunks.push(ev.data); };
  mediaRecorder.onstart = ()=> setStatus("ÎÖπÏùå Ï§ë‚Ä¶ Î¨∏Ïû•ÏùÑ ÎßêÌïòÏÑ∏Ïöî.");
  mediaRecorder.start();

  startBtn.disabled = true; stopBtn.disabled = false; resetBtn.disabled = true;
  drawAxes(+floor.value, +ceil.value);
  document.getElementById('now').textContent = "F0: -- Hz";
};

stopBtn.onclick = async () => {
  stopBtn.disabled = true;
  if(!mediaRecorder){ return; }
  setStatus("Ï≤òÎ¶¨ Ï§ë‚Ä¶(1Ï¥à ÎÇ¥)");
  mediaRecorder.onstop = async ()=>{
    // Ìï©ÏπòÍ∏∞ ‚Üí ÎîîÏΩîÎìú ‚Üí Î∂ÑÏÑù
    const blob = new Blob(chunks);
    chunks.length = 0;

    const arrayBuf = await blob.arrayBuffer();
    const ctx = await ensureAudioContext();
    const audioBuf = await ctx.decodeAudioData(arrayBuf.slice(0));

    // Îã®Ïùº Ï±ÑÎÑê Ïã†Ìò∏ Ï∑®Îìù + Ï†ïÍ∑úÌôî
    const ch = audioBuf.numberOfChannels ? audioBuf.getChannelData(0) : new Float32Array(arrayBuf.byteLength/4);
    const signal = new Float32Array(ch.length);
    let peak = 0; for(let i=0;i<ch.length;i++){ const v=Math.max(-1,Math.min(1,ch[i])); peak=Math.max(peak,Math.abs(v)); signal[i]=v; }
    if(peak>0){ const s=1/peak; for(let i=0;i<signal.length;i++) signal[i]*=s; }

    const floorHz = +document.getElementById('floor').value || 75;
    const ceilHz  = +document.getElementById('ceil').value  || 400;
    const f0sRaw  = trackPitch(signal, audioBuf.sampleRate, floorHz, ceilHz, 30, 17); // ‚òÖ Ïó¨Í∏∞ÏÑúÎèÑ hopMs 20
    const k = +document.getElementById('smooth').value;
    const f0s = medianSmooth(f0sRaw, k);

    // ÎßàÏßÄÎßâ Ï∂îÏ†ïÍ∞í ÌëúÏãú (Safari Ìò∏ÌôòÏö©)
    const last = f0s.findLast ? (f0s.findLast(v=>v>0)||0)
      : (function(){ for(let i=f0s.length-1;i>=0;i--) if(f0s[i]>0) return f0s[i]; return 0; })();
    document.getElementById('now').textContent = "F0: " + (last? Math.round(last) : "--") + " Hz";

    drawContour(f0s, floorHz, ceilHz);
    setStatus("ÏôÑÎ£å. Îã§Ïãú ÎÖπÏùåÌïòÎ†§Î©¥ Reset ‚Üí Start");
    resetBtn.disabled = false;
  };
  mediaRecorder.stop();
  if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
};

resetBtn.onclick = ()=>{
  drawAxes(+floor.value, +ceil.value);
  document.getElementById('now').textContent = "F0: -- Hz";
  setStatus("Ï§ÄÎπÑ ÏôÑÎ£å");
  startBtn.disabled=false; stopBtn.disabled=true; resetBtn.disabled=true;
};

// Ï¥àÍ∏∞ Ï∂ï
drawAxes(+floor.value, +ceil.value);
</script>
</html>


