<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>í•œêµ­ì–´ ì–µì–‘ ì›¹ì•± (ì‹¤ì‹œê°„ + ë¬¸ì¥ ì—°ìŠµ)</title>
<style>
  :root { --fg:#222; }
  body { font-family: system-ui, sans-serif; margin:16px; color:var(--fg);}
  h1 { font-size: 20px; margin-bottom: 8px;}
  h2 { font-size: 16px; margin:16px 0 8px;}
  #c { width:100%; height:260px; border:1px solid #ddd; border-radius:8px;}
  .row { display:flex; flex-wrap:wrap; gap:10px; margin:10px 0; align-items:center;}
  button { padding:8px 12px; border:1px solid #ccc; border-radius:8px; cursor:pointer; background:#fff;}
  button[disabled]{opacity:0.5; cursor:default;}
  input[type=number]{width:90px;}
  .tabs { display:flex; gap:8px; margin:16px 0;}
  .tab-btn { padding:8px 16px; border-radius:16px; border:1px solid #ccc; cursor:pointer; background:#f7f7f7;}
  .tab-btn.active { background:#0a74da; color:#fff; border-color:#0a74da;}
  .tab { display:none; }
  .tab.active { display:block; }
  #feedback { margin-top:8px; font-size:14px; color:#333; }
  .sent-button { padding:6px 10px; border-radius:6px; border:1px solid #ddd; background:#fafafa;}
  .meta { font-size:12px; color:#666; }
  .legend { font-size:12px; margin-top:4px; }
  .legend span { display:inline-block; margin-right:12px; }
  .legend-color { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:4px; vertical-align:middle;}
</style>

<body>
<h1>ğŸ¤ í•œêµ­ì–´ ì–µì–‘ ì›¹ì•± (ë°ëª¨)</h1>

<div class="tabs">
  <button class="tab-btn active" data-tab="live">ì‹¤ì‹œê°„ F0 ë³´ê¸°</button>
  <button class="tab-btn" data-tab="practice">ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ</button>
</div>

<!-- ê³µí†µ: F0 ìº”ë²„ìŠ¤ -->
<canvas id="c" width="1200" height="260"></canvas>
<div class="legend">
  <span><span class="legend-color" style="background:#0a74da;"></span>ì‹¤ì‹œê°„/ë‚´ ë°œí™” F0</span>
  <span><span class="legend-color" style="background:#ff6666;"></span>ë‚´ ë°œí™” F0(ì—°ìŠµ ëª¨ë“œ)</span>
  <span><span class="legend-color" style="background:#888888;"></span>ëª¨ë²” ë°œí™” F0</span>
</div>
<div class="row meta">
  <div>í˜„ì¬ F0: <span id="now">-- Hz</span></div>
  <div style="margin-left:auto;">
    Floor(Hz) <input id="floor" type="number" value="75" min="40" max="200">
    Ceiling(Hz) <input id="ceil" type="number" value="400" min="200" max="800">
  </div>
</div>

<!-- íƒ­ 1: ì‹¤ì‹œê°„ F0 ë³´ê¸° -->
<div class="tab active" id="tab-live">
  <h2>â‘  ì‹¤ì‹œê°„ ì–µì–‘(F0) ê³¡ì„  ë³´ê¸°</h2>
  <div class="row">
    <button id="start">Start</button>
    <button id="stop" disabled>Stop</button>
  </div>
  <p class="meta">
    ë§ˆì´í¬ë¥¼ ì¼œê³  ë§í•´ ë³´ì„¸ìš”. íŒŒë€ ì„ ì´ ì‹¤ì‹œê°„ F0 ê³¡ì„ ì…ë‹ˆë‹¤.
  </p>
</div>

<!-- íƒ­ 2: ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ -->
<div class="tab" id="tab-practice">
  <h2>â‘¡ ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ (ëª¨ë²” ì–µì–‘ vs ë‚´ ì–µì–‘ ë¹„êµ)</h2>

  <div class="row">
    <span>ë¬¸ì¥ ì„ íƒ:</span>
    <button class="sent-button" data-audio="audio/s1_native.wav" data-text="ì˜¤ëŠ˜ ì–´ë””ì— ê°€ìš”?">ë¬¸ì¥ 1</button>
    <!-- í•„ìš”í•˜ë©´ ë¬¸ì¥ 2,3 ì¶”ê°€ -->
    <!--
    <button class="sent-button" data-audio="audio/s2_native.wav" data-text="ì´ ì±… ì–´ë•Œìš”?">ë¬¸ì¥ 2</button>
    -->
  </div>

  <div class="row">
    <div id="sent-text" class="meta">ë¬¸ì¥ì„ ì„ íƒí•˜ë©´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>

  <div class="row">
    <button id="play-native" disabled>ëª¨ë²” ë°œìŒ ì¬ìƒ</button>
    <button id="record-once" disabled>ë‚´ ë°œìŒ ë…¹ìŒ(1íšŒ)</button>
  </div>

  <p class="meta">
    1) ë¬¸ì¥ì„ ì„ íƒí•˜ê³ , 2) ëª¨ë²” ë°œìŒì„ ì—¬ëŸ¬ ë²ˆ ë“¤ì–´ ë³¸ ë’¤, 3) ë‚´ ë°œìŒì„ ë…¹ìŒí•˜ë©´<br>
    íšŒìƒ‰ ì„ (ëª¨ë²”)ê³¼ ë¹¨ê°„ ì„ (ë‚´ ë°œìŒ)ì˜ F0 ê³¡ì„ ì´ ë¹„êµë˜ì–´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
  </p>

  <div id="feedback"></div>
</div>

<script>
// ====== ê³µí†µ ë³€ìˆ˜ ë° ë„êµ¬ í•¨ìˆ˜ ======
let audioCtx, source, processor, stream, animId;
const c = document.getElementById('c'), g = c.getContext('2d');
const livePoints = [];          // ì‹¤ì‹œê°„ ëª¨ë“œìš© F0
const practiceUserPoints = [];  // ì—°ìŠµ ëª¨ë“œ: ë‚´ ë°œí™” F0
const practiceNativePoints = []; // ì—°ìŠµ ëª¨ë“œ: ëª¨ë²” F0
const maxPoints = 1000;

function getFloor() { return +document.getElementById('floor').value || 75; }
function getCeil()  { return +document.getElementById('ceil').value || 400; }

// ìë™ìƒê´€ ê¸°ë°˜ F0 ì¶”ì • (ê¸°ì¡´ ì½”ë“œ ì¬ì‚¬ìš©)
function autoCorrelate(buf, sr, floor=75, ceil=400){
  const N = buf.length;
  let mean=0; for(let i=0;i<N;i++) mean+=buf[i]; mean/=N;
  for(let i=0;i<N;i++) buf[i]=(buf[i]-mean)*(0.5-0.5*Math.cos(2*Math.PI*i/(N-1)));
  const maxLag=Math.floor(sr/floor), minLag=Math.floor(sr/ceil);
  let rms=0; for(let i=0;i<N;i++) rms+=buf[i]*buf[i]; rms=Math.sqrt(rms/N);
  if(rms<0.01) return 0;
  const xcorr=(lag)=>{let s=0;for(let i=0;i<N-lag;i++) s+=buf[i]*buf[i+lag];return s/(N-lag);}
  let bestLag=-1,best=0;
  for(let lag=minLag;lag<=maxLag;lag++){const c=xcorr(lag);if(c>best){best=c;bestLag=lag;}}
  if(bestLag<0||best<0.1) return 0;
  const c1=xcorr(bestLag-1), c2=xcorr(bestLag), c3=xcorr(bestLag+1);
  const denom=(c1-2*c2+c3); let shift=0;
  if(Math.abs(denom)>1e-6) shift=0.5*(c1-c3)/denom;
  return sr/(bestLag+shift);
}

// ì˜¤ë””ì˜¤ ë²„í¼ë¡œë¶€í„° F0 íŠ¸ë™ ê³„ì‚° (ì—°ìŠµ ëª¨ë“œìš©)
function computeF0Track(floatBuf, sr, frameSize=2048, hopSize=512){
  const floor = getFloor(), ceil = getCeil();
  const len = floatBuf.length;
  const f0s = [];
  for(let start=0; start+frameSize <= len; start += hopSize){
    const frame = floatBuf.slice(start, start+frameSize);
    const f0 = autoCorrelate(new Float32Array(frame), sr, floor, ceil);
    f0s.push(f0 > 0 ? f0 : 0);
  }
  return f0s;
}

// ê³µí†µ ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸° ë£¨í”„
function draw(){
  g.clearRect(0,0,c.width,c.height);
  const floor = getFloor(), ceil = getCeil();

  // ì¶•/ëˆˆê¸ˆ
  g.strokeStyle="#eee"; g.beginPath(); g.moveTo(48,16); g.lineTo(48,244); g.lineTo(1184,244); g.stroke();
  [floor,(floor+ceil)/2,ceil].forEach(t=>{
    const y=mapF0(t,floor,ceil);
    g.strokeStyle="#eee"; g.beginPath(); g.moveTo(48,y); g.lineTo(1184,y); g.stroke();
    g.fillStyle="#666"; g.font="12px system-ui"; g.fillText(Math.round(t)+" Hz",8,y-2);
  });

  // ì‹¤ì‹œê°„ F0 (íŒŒë€ìƒ‰)
  drawTrack(livePoints, "#0a74da", floor, ceil);

  // ì—°ìŠµ ëª¨ë“œ: ëª¨ë²” F0 (íšŒìƒ‰)
  drawTrack(practiceNativePoints, "#888888", floor, ceil);

  // ì—°ìŠµ ëª¨ë“œ: ë‚´ ë°œí™” F0 (ë¹¨ê°„ìƒ‰)
  drawTrack(practiceUserPoints, "#ff6666", floor, ceil);

  animId = requestAnimationFrame(draw);
}

function mapF0(f,fmin,fmax){
  const clamped = Math.max(fmin,Math.min(fmax,f));
  const r = (clamped-fmin)/(fmax-fmin);
  return 244 - r*220;
}

function drawTrack(arr, color, floor, ceil){
  if(!arr.length) return;
  g.strokeStyle = color; g.beginPath();
  const visible = arr.slice(-maxPoints);
  let started=false;
  for(let i=0;i<visible.length;i++){
    const f0 = visible[i];
    if(f0<=0){ started=false; continue; }
    const x = 48+(i/Math.max(visible.length-1,1))*1136;
    const y = mapF0(f0,floor,ceil);
    if(!started){ g.moveTo(x,y); started=true; }
    else{ g.lineTo(x,y); }
  }
  g.stroke();
}

// ====== íƒ­ ì „í™˜ ======
const tabBtns = document.querySelectorAll('.tab-btn');
const tabs = {
  live: document.getElementById('tab-live'),
  practice: document.getElementById('tab-practice')
};

tabBtns.forEach(btn=>{
  btn.onclick = ()=>{
    tabBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tabId = btn.dataset.tab;
    Object.keys(tabs).forEach(id=>{
      tabs[id].classList.toggle('active', id===tabId);
    });
  };
});

// ====== ì‹¤ì‹œê°„ ëª¨ë“œ ======
const startBtn=document.getElementById('start'),
      stopBtn=document.getElementById('stop');

async function startLive(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({audio:true});
  }catch(e){
    alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤."); return;
  }
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  source=audioCtx.createMediaStreamSource(stream);
  processor=audioCtx.createScriptProcessor(2048,1,1);
  source.connect(processor); processor.connect(audioCtx.destination);
  processor.onaudioprocess=(e)=>{
    const inbuf=e.inputBuffer.getChannelData(0);
    const f0=autoCorrelate(new Float32Array(inbuf),audioCtx.sampleRate,getFloor(),getCeil());
    livePoints.push(f0>0?f0:0); if(livePoints.length>5000) livePoints.shift();
    document.getElementById('now').textContent = (f0?Math.round(f0):"--")+" Hz";
  };
  if(!animId) draw();
  startBtn.disabled=true; stopBtn.disabled=false;
}
function stopLive(){
  if(processor){processor.disconnect();processor.onaudioprocess=null;}
  if(source) source.disconnect();
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
  if(audioCtx){audioCtx.close();audioCtx=null;}
  startBtn.disabled=false; stopBtn.disabled=true;
}
startBtn.onclick=startLive;
stopBtn.onclick=stopLive;

// ====== ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ ======
const sentButtons = document.querySelectorAll('.sent-button');
const sentText = document.getElementById('sent-text');
const playNativeBtn = document.getElementById('play-native');
const recordOnceBtn = document.getElementById('record-once');
const feedbackEl = document.getElementById('feedback');

let nativeAudioBuffer = null;
let practiceAudioCtx = null;

sentButtons.forEach(btn=>{
  btn.onclick = async ()=>{
    const audioPath = btn.dataset.audio;
    const text = btn.dataset.text || "";
    sentText.textContent = text;

    // ëª¨ë²” ìŒì„± ë¡œë“œ
    try{
      if(!practiceAudioCtx) practiceAudioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const res = await fetch(audioPath);
      const arrBuf = await res.arrayBuffer();
      nativeAudioBuffer = await practiceAudioCtx.decodeAudioData(arrBuf);
      feedbackEl.textContent = "ëª¨ë²” ìŒì„±ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. 'ëª¨ë²” ë°œìŒ ì¬ìƒ'ì„ ëˆŒëŸ¬ ë“¤ì–´ ë³´ì„¸ìš”.";
      playNativeBtn.disabled = false;
      recordOnceBtn.disabled = false;
    }catch(e){
      console.error(e);
      feedbackEl.textContent = "ëª¨ë²” ìŒì„±ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. audio ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.";
      playNativeBtn.disabled = true;
      recordOnceBtn.disabled = true;
    }
  };
});

playNativeBtn.onclick = ()=>{
  if(!nativeAudioBuffer || !practiceAudioCtx) return;
  const src = practiceAudioCtx.createBufferSource();
  src.buffer = nativeAudioBuffer;
  src.connect(practiceAudioCtx.destination);
  src.start();
};

// 1íšŒ ë…¹ìŒ í›„ F0 ë¹„êµ
recordOnceBtn.onclick = async ()=>{
  feedbackEl.textContent = "ë…¹ìŒì„ ì‹œì‘í•©ë‹ˆë‹¤. 'ì‚‘' ì†Œë¦¬ê°€ ë‚œ ë’¤ ë¬¸ì¥ì„ ë§í•´ ì£¼ì„¸ìš”.";
  let recStream;
  try{
    recStream = await navigator.mediaDevices.getUserMedia({audio:true});
  }catch(e){
    alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤."); return;
  }
  const recCtx = new (window.AudioContext||window.webkitAudioContext)();
  const recSource = recCtx.createMediaStreamSource(recStream);
  const recProcessor = recCtx.createScriptProcessor(2048,1,1);
  const chunks = [];
  recSource.connect(recProcessor);
  recProcessor.connect(recCtx.destination);

  let recording = true;
  setTimeout(()=>{ // 3ì´ˆ ë’¤ ìë™ ì¢…ë£Œ (í•„ìš”í•˜ë©´ ì¡°ì ˆ)
    recording=false;
  }, 3000);

  recProcessor.onaudioprocess = (e)=>{
    if(!recording){
      recProcessor.disconnect(); recSource.disconnect();
      recStream.getTracks().forEach(t=>t.stop());
      recCtx.close();
      processPractice(nativeAudioBuffer, chunks, recCtx.sampleRate);
      recProcessor.onaudioprocess = null;
      return;
    }
    const buf = e.inputBuffer.getChannelData(0);
    chunks.push(new Float32Array(buf));
  };
};

// ëª¨ë²”/ë‚´ ë°œí™” F0 ê³„ì‚° í›„ ìº”ë²„ìŠ¤ì— ë°˜ì˜ + ê°„ë‹¨ í”¼ë“œë°±
function processPractice(nativeBuf, userChunks, userSr){
  if(!nativeBuf){
    feedbackEl.textContent = "ëª¨ë²” ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤."; return;
  }
  // ì—°ì† ë²„í¼ë¡œ í•©ì¹˜ê¸°
  const userLength = userChunks.reduce((s,cur)=>s+cur.length,0);
  const userFloat = new Float32Array(userLength);
  let offset = 0;
  for(const ch of userChunks){
    userFloat.set(ch, offset); offset += ch.length;
  }

  // ëª¨ë²”/ë‚´ ë°œí™” ê°ê° F0 íŠ¸ë™ ê³„ì‚°
  const nativeFloat = nativeBuf.getChannelData(0);
  const nativeTrack = computeF0Track(nativeFloat, nativeBuf.sampleRate);
  const userTrack = computeF0Track(userFloat, userSr);

  practiceNativePoints.length = 0;
  practiceUserPoints.length = 0;
  practiceNativePoints.push(...nativeTrack);
  practiceUserPoints.push(...userTrack);

  // ê°„ë‹¨í•œ ë¬¸ë§ í”¼ë“œë°±
  const lastN = 10;
  const u = userTrack.slice(-lastN).filter(x=>x>0);
  const n = nativeTrack.slice(-lastN).filter(x=>x>0);
  let msg = "ë°œí™”ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
  if(u.length && n.length){
    const uStart = u[0], uEnd = u[u.length-1];
    const nStart = n[0], nEnd = n[n.length-1];
    const uSlope = uEnd - uStart;
    const nSlope = nEnd - nStart;
    if(nSlope > 0 && uSlope <= 0){
      msg += " íŒì • ì˜ë¬¸ë¬¸ì—ì„œ ë¬¸ë§ ì–µì–‘ì´ ì¶©ë¶„íˆ ì˜¬ë¼ê°€ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë§ˆì§€ë§‰ ìŒì ˆì„ ë” ì˜¬ë ¤ ë³´ì„¸ìš”.";
    }else if(nSlope < 0 && uSlope >= 0){
      msg += " ì„¤ëª… ì˜ë¬¸ë¬¸ì—ì„œ ë¬¸ë§ ì–µì–‘ì´ ë„ˆë¬´ ì˜¬ë¼ê°€ ìˆìŠµë‹ˆë‹¤. ë§ˆì§€ë§‰ ë¶€ë¶„ì„ ìì—°ìŠ¤ëŸ½ê²Œ ë‚´ë ¤ ë³´ì„¸ìš”.";
    }else{
      msg += " ë¬¸ë§ ì–µì–‘ ë°©í–¥ì€ ëª¨ë²” ë°œìŒê³¼ ë¹„ìŠ·í•©ë‹ˆë‹¤. ì „ì²´ì ì¸ ë†’ë‚®ì´ ëŒ€ë¹„ë¥¼ ì¡°ê¸ˆ ë” í‚¤ì›Œ ë³´ì„¸ìš”.";
    }
  }
  feedbackEl.textContent = msg;

  // ì‹¤ì‹œê°„ F0ëŠ” êº¼ë„ ë˜ê³ , ê·¸ëŒ€ë¡œ ë‘¬ë„ ë¨
  document.getElementById('now').textContent = "-- Hz";
}

// ìµœì´ˆ draw ì‹œì‘
draw();
</script>
</body>
</html>
