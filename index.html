<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í•œêµ­ì–´ ì–µì–‘ ì›¹ì•± (ë°ëª¨)</title>
  <style>
    :root {
      --fg: #222;
      --blue: #0a74da;
      --red: #e65b5b;
      --gray: #888;
      --bg: #fafafa;
    }
    * { box-sizing: border-box; }
    body {
      margin: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--fg);
      background: #fff;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    h2 {
      font-size: 16px;
      margin: 18px 0 8px;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .tab-btn {
      flex: 0 0 auto;
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    .tab-btn.active {
      background: var(--blue);
      color: #fff;
      border-color: var(--blue);
    }
    .panel.hidden { display: none; }

    #canvas-box {
      margin: 12px 0;
      background: #fff;
      border-radius: 16px;
      border: 1px solid #e5e5e5;
      padding: 8px;
    }
    #c {
      width: 100%;
      height: 260px;
      border-radius: 12px;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 6px;
      align-items: center;
      font-size: 13px;
    }
    .dot {
      width: 10px; height: 10px;
      border-radius: 999px;
      display: inline-block;
      margin-right: 4px;
    }
    .dot.live { background: var(--blue); }
    .dot.model { background: var(--gray); }
    .dot.user { background: var(--red); }

    .now-f0 {
      margin-top: 6px;
      font-size: 13px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin: 8px 0 4px;
      font-size: 13px;
    }
    .row label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    input[type="number"] {
      width: 80px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 13px;
    }

    button {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    button.primary {
      background: var(--blue);
      color: #fff;
      border-color: var(--blue);
    }

    .section-title {
      font-weight: 600;
      margin-top: 16px;
      margin-bottom: 4px;
    }
    .caption {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }

    /* ì—°ìŠµ ëª¨ë“œ */
    .wh-group-wrap {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    .wh-card {
      border-radius: 12px;
      border: 1px solid #eee;
      padding: 8px;
      background: #fafafa;
    }
    .wh-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .sent-btn {
      display: block;
      width: 100%;
      text-align: left;
      font-size: 13px;
      margin-top: 4px;
    }
    .sent-btn.active {
      border-color: var(--blue);
      color: var(--blue);
      background: #e6f2ff;
    }
    .practice-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    @media (max-width: 600px) {
      body { margin: 12px; }
      #c { height: 220px; }
    }
  </style>
</head>
<body>
  <h1>ğŸ¤ í•œêµ­ì–´ ì–µì–‘ ì›¹ì•±</h1>

  <div class="tabs">
    <button class="tab-btn active" data-tab="live">ì‹¤ì‹œê°„ F0 ë³´ê¸°</button>
    <button class="tab-btn" data-tab="practice">ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ</button>
  </div>

  <div id="canvas-box">
    <canvas id="c" width="1200" height="260"></canvas>
    <div class="legend">
      <span><span class="dot live"></span>ì‹¤ì‹œê°„ F0 (Start/Stop)</span>
      <span><span class="dot model"></span>ëª¨ë²” ë°œí™” F0 (ì—°ìŠµ ëª¨ë“œ)</span>
      <span><span class="dot user"></span>ë‚´ ë°œí™” F0 (ì—°ìŠµ ëª¨ë“œ)</span>
    </div>
    <div id="now" class="now-f0">í˜„ì¬ F0: -- Hz</div>
    <div class="row">
      <label>Floor(Hz)
        <input id="floor" type="number" value="75" min="40" max="200" />
      </label>
      <label>Ceiling(Hz)
        <input id="ceil" type="number" value="400" min="200" max="800" />
      </label>
    </div>
  </div>

  <!-- ì‹¤ì‹œê°„ ëª¨ë“œ íŒ¨ë„ -->
  <div id="tab-live" class="panel">
    <div class="section-title">â‘  ì‹¤ì‹œê°„ ì–µì–‘(F0) ê³¡ì„  ë³´ê¸°</div>
    <div class="caption">
      Startë¥¼ ëˆŒëŸ¬ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•œ ë’¤ ë§ì„ í•´ ë³´ì„¸ìš”.  
      í•˜ëŠ˜ìƒ‰ ì„ ì´ ì‹¤ì‹œê°„ F0 ê³¡ì„ ì…ë‹ˆë‹¤. Stopì„ ëˆŒëŸ¬ë„ ê³¡ì„ ì€ í™”ë©´ì— ë‚¨ìŠµë‹ˆë‹¤.
    </div>
    <div class="row">
      <button id="start" class="primary">Start</button>
      <button id="stop" disabled>Stop</button>
    </div>
  </div>

  <!-- ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ íŒ¨ë„ -->
  <div id="tab-practice" class="panel hidden">
    <div class="section-title">â‘¡ ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ</div>
    <div class="caption">
      ì˜ë¬¸ì‚¬ë¥¼ ì„ íƒí•˜ê³ , íŒì • ì˜ë¬¸ë¬¸(Y/N)ê³¼ ì„¤ëª… ì˜ë¬¸ë¬¸(Wh) ì–µì–‘ì„ ë¹„êµí•´ ë³´ì„¸ìš”.
      ëª¨ë²” ë°œí™”ë¥¼ ë“£ê³ , ë‚´ ì–µì–‘ì„ ë…¹ìŒí•˜ì—¬ ê³¡ì„ ì„ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>

    <div class="wh-group-wrap">
      <div class="wh-card">
        <div class="wh-title">ëˆ„êµ¬</div>
        <button class="sent-btn" data-sent="nugu_yn">ëˆ„êµ¬ ë§Œë‚˜ìš”? (íŒì •)</button>
        <button class="sent-btn" data-sent="nugu_wh">ëˆ„êµ¬ ë§Œë‚˜ìš”? (ì„¤ëª…)</button>
      </div>
      <div class="wh-card">
        <div class="wh-title">ì–´ë””</div>
        <button class="sent-btn" data-sent="eodi_yn">ì–´ë”” ê°€ìš”? (íŒì •)</button>
        <button class="sent-btn" data-sent="eodi_wh">ì–´ë”” ê°€ìš”? (ì„¤ëª…)</button>
      </div>
      <div class="wh-card">
        <div class="wh-title">ì–¸ì œ</div>
        <button class="sent-btn" data-sent="eonje_yn">ì–¸ì œ ì™€ìš”? (íŒì •)</button>
        <button class="sent-btn" data-sent="eonje_wh">ì–¸ì œ ì™€ìš”? (ì„¤ëª…)</button>
      </div>
      <div class="wh-card">
        <div class="wh-title">ë­</div>
        <button class="sent-btn" data-sent="mwo_yn">ë­ í•´ìš”? (íŒì •)</button>
        <button class="sent-btn" data-sent="mwo_wh">ë­ í•´ìš”? (ì„¤ëª…)</button>
      </div>
    </div>

    <div class="practice-controls">
      <button id="btn-play-model">ëª¨ë²” ë°œí™” ì¬ìƒ</button>
      <button id="btn-prac-start" class="primary">ë‚´ ë°œí™” ë…¹ìŒ ì‹œì‘</button>
      <button id="btn-prac-stop" disabled>ë…¹ìŒ ì¢…ë£Œ</button>
    </div>
    <div class="caption">
      âš ï¸ ëª¨ë²” ë°œí™” íŒŒì¼ì€ <code>/audio</code> í´ë”ì—  
      <code>nugu_yn.wav, nugu_wh.wav, eodi_yn.wav, eodi_wh.wav, eonje_yn.wav, eonje_wh.wav, mwo_yn.wav, mwo_wh.wav</code>  
      ì´ë¦„ìœ¼ë¡œ ë„£ì–´ ë‘ì–´ì•¼ í•©ë‹ˆë‹¤.
    </div>
  </div>

  <script>
    // ===== íƒ­ ì „í™˜ =====
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabPanels = {
      live: document.getElementById('tab-live'),
      practice: document.getElementById('tab-practice')
    };
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.tab;
        tabButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        Object.keys(tabPanels).forEach(key => {
          tabPanels[key].classList.toggle('hidden', key !== target);
        });
      });
    });

    // ===== ê³µí†µ: F0 ê³„ì‚° í•¨ìˆ˜ =====
    function autoCorrelate(buf, sr, floor = 75, ceil = 400) {
      const N = buf.length;
      let mean = 0;
      for (let i = 0; i < N; i++) mean += buf[i];
      mean /= N;

      // í‰ê·  ì œê±° + í•´ë‹ ìœˆë„ìš°
      for (let i = 0; i < N; i++) {
        buf[i] = (buf[i] - mean) * (0.5 - 0.5 * Math.cos(2 * Math.PI * i / (N - 1)));
      }

      // RMS ê³„ì‚° (ì‘ì€ ëª©ì†Œë¦¬ë„ ì¡íˆë„ë¡ ì„ê³„ê°’ ë‚®ì¶¤)
      let rms = 0;
      for (let i = 0; i < N; i++) rms += buf[i] * buf[i];
      rms = Math.sqrt(rms / N);
      if (rms < 0.002) return 0;

      const maxLag = Math.floor(sr / floor);
      const minLag = Math.floor(sr / ceil);

      const xcorr = (lag) => {
        let s = 0;
        for (let i = 0; i < N - lag; i++) s += buf[i] * buf[i + lag];
        return s / (N - lag);
      };

      let bestLag = -1, best = 0;
      for (let lag = minLag; lag <= maxLag; lag++) {
        const c = xcorr(lag);
        if (c > best) { best = c; bestLag = lag; }
      }
      if (bestLag < 0 || best < 0.08) return 0;

      const c1 = xcorr(bestLag - 1), c2 = xcorr(bestLag), c3 = xcorr(bestLag + 1);
      const denom = (c1 - 2 * c2 + c3);
      let shift = 0;
      if (Math.abs(denom) > 1e-6) shift = 0.5 * (c1 - c3) / denom;

      return sr / (bestLag + shift);
    }

    // ===== ê³µí†µ: ê·¸ë˜í”„ ê·¸ë¦¬ê¸° =====
    const c = document.getElementById('c');
    const g = c.getContext('2d');
    const livePoints = [];
    const modelPoints = [];
    const userPoints = [];
    const maxPoints = 1000;

    function getFloor() {
      return +document.getElementById('floor').value || 75;
    }
    function getCeil() {
      return +document.getElementById('ceil').value || 400;
    }

    function mapF0(f, fmin, fmax) {
      const clamped = Math.max(fmin, Math.min(fmax, f));
      const r = (clamped - fmin) / (fmax - fmin);
      return 244 - r * 220;
    }

    function drawSeries(points, color, floor, ceil) {
      const visible = points.slice(-maxPoints);
      if (!visible.length) return;
      g.strokeStyle = color;
      g.lineWidth = 2;
      g.beginPath();
      let started = false;
      for (let i = 0; i < visible.length; i++) {
        const f0 = visible[i];
        if (f0 <= 0) { started = false; continue; }

        const x = 48 + (i / Math.max(visible.length - 1, 1)) * 1136;
        const y = mapF0(f0, floor, ceil);

        if (!started) { g.moveTo(x, y); started = true; }
        else { g.lineTo(x, y); }
      }
      g.stroke();
      g.lineWidth = 1;
    }

    function draw() {
      g.clearRect(0, 0, c.width, c.height);

      // í‹€
      g.strokeStyle = "#eee";
      g.beginPath();
      g.moveTo(48, 16);
      g.lineTo(48, 244);
      g.lineTo(1184, 244);
      g.stroke();

      const floor = getFloor();
      const ceil = getCeil();

      [floor, (floor + ceil) / 2, ceil].forEach(t => {
        const y = mapF0(t, floor, ceil);
        g.strokeStyle = "#eee";
        g.beginPath();
        g.moveTo(48, y);
        g.lineTo(1184, y);
        g.stroke();
        g.fillStyle = "#666";
        g.font = "12px system-ui";
        g.fillText(Math.round(t) + " Hz", 8, y - 2);
      });

      drawSeries(modelPoints, "#888888", floor, ceil);
      drawSeries(userPoints, "#e65b5b", floor, ceil);
      drawSeries(livePoints, "#0a74da", floor, ceil);

      requestAnimationFrame(draw);
    }
    requestAnimationFrame(draw);

    // ===== ì‹¤ì‹œê°„ ëª¨ë“œ =====
    let audioCtxLive = null;
    let sourceLive = null;
    let processorLive = null;
    let streamLive = null;

    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const nowEl = document.getElementById('now');

    async function startLive() {
      if (audioCtxLive) return;
      try {
        streamLive = await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (e) {
        alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. (ë˜ëŠ” HTTPS í™˜ê²½ì¸ì§€ í™•ì¸í•˜ì„¸ìš”)");
        console.error(e);
        return;
      }

      audioCtxLive = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtxLive.state === 'suspended') {
        await audioCtxLive.resume();
      }

      sourceLive = audioCtxLive.createMediaStreamSource(streamLive);
      processorLive = audioCtxLive.createScriptProcessor(2048, 1, 1);

      sourceLive.connect(processorLive);
      processorLive.connect(audioCtxLive.destination);

      processorLive.onaudioprocess = (e) => {
        const inbuf = e.inputBuffer.getChannelData(0);
        const tmp = new Float32Array(inbuf);
        const f0 = autoCorrelate(tmp, audioCtxLive.sampleRate, getFloor(), getCeil());

        livePoints.push(f0 > 0 ? f0 : 0);
        if (livePoints.length > 5000) livePoints.shift();

        nowEl.textContent = "í˜„ì¬ F0: " + (f0 ? Math.round(f0) + " Hz" : "-- Hz");
      };

      startBtn.disabled = true;
      stopBtn.disabled = false;
    }

    function stopLive() {
      if (processorLive) {
        processorLive.disconnect();
        processorLive.onaudioprocess = null;
        processorLive = null;
      }
      if (sourceLive) {
        sourceLive.disconnect();
        sourceLive = null;
      }
      if (streamLive) {
        streamLive.getTracks().forEach(t => t.stop());
        streamLive = null;
      }
      if (audioCtxLive) {
        audioCtxLive.close();
        audioCtxLive = null;
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
      nowEl.textContent = "í˜„ì¬ F0: -- Hz";
    }

    startBtn.addEventListener('click', startLive);
    stopBtn.addEventListener('click', stopLive);

    // ===== ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ =====
    const sentenceDefs = {
      "eodi_yn":  { file: "audio/eodi_yn.wav",  label: "ì–´ë”” ê°€ìš”? (Y/N)" },
      "eodi_wh":  { file: "audio/eodi_wh.wav",  label: "ì–´ë”” ê°€ìš”? (WH)" },
      "nugu_yn":  { file: "audio/nugu_yn.wav",  label: "ëˆ„êµ¬ ë§Œë‚˜ìš”? (Y/N)" },
      "nugu_wh":  { file: "audio/nugu_wh.wav",  label: "ëˆ„êµ¬ ë§Œë‚˜ìš”? (WH)" },
      "eonje_yn": { file: "audio/eonje_yn.wav", label: "ì–¸ì œ ë§Œë‚ ë˜ìš”? (Y/N)" },
      "eonje_wh": { file: "audio/eonje_wh.wav", label: "ì–¸ì œ ë§Œë‚ ë˜ìš”? (WH)" },
      "mwo_yn":   { file: "audio/mwo_yn.wav",   label: "ë­ ë¨¹ì„ë˜ìš”? (Y/N)" },
      "mwo_wh":   { file: "audio/mwo_wh.wav",   label: "ë­ ë¨¹ì„ë˜ìš”? (WH)" }
    };

    const sentenceBuffers = {};
    const sentBtns = document.querySelectorAll('.sent-btn');
    let currentSentKey = null;

    async function loadSentenceBuffer(key) {
      if (!sentenceDefs[key]) return null;
      if (sentenceBuffers[key]) return sentenceBuffers[key];

      const def = sentenceDefs[key];
      try {
        const resp = await fetch(def.file);
        if (!resp.ok) throw new Error("File not found");
        const arrayBuf = await resp.arrayBuffer();
        const tmpCtx = new (window.AudioContext || window.webkitAudioContext)();
        const buffer = await tmpCtx.decodeAudioData(arrayBuf);
        tmpCtx.close();
        sentenceBuffers[key] = buffer;
        return buffer;
      } catch (e) {
        alert("ëª¨ë²” ë°œí™” íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: " + def.file);
        console.error(e);
        return null;
      }
    }

    async function updateModelF0(key) {
      const buffer = await loadSentenceBuffer(key);
      if (!buffer) return;
      const data = buffer.getChannelData(0);
      const sr = buffer.sampleRate;
      const size = 2048;
      const hop = 512;
      const tmp = new Float32Array(size);
      modelPoints.length = 0;

      const floor = getFloor();
      const ceil = getCeil();

      for (let pos = 0; pos + size < data.length; pos += hop) {
        for (let i = 0; i < size; i++) tmp[i] = data[pos + i];
        const f0 = autoCorrelate(new Float32Array(tmp), sr, floor, ceil);
        modelPoints.push(f0 > 0 ? f0 : 0);
        if (modelPoints.length > 5000) break;
      }
    }

    sentBtns.forEach(btn => {
      btn.addEventListener('click', async () => {
        const key = btn.dataset.sent;
        currentSentKey = key;
        sentBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        userPoints.length = 0;
        await updateModelF0(key);
      });
    });

    const btnPlayModel = document.getElementById('btn-play-model');
    btnPlayModel.addEventListener('click', async () => {
      if (!currentSentKey) {
        alert("ë¨¼ì € ì—°ìŠµí•  ë¬¸ì¥ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
      }
      const buffer = await loadSentenceBuffer(currentSentKey);
      if (!buffer) return;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const src = ctx.createBufferSource();
      src.buffer = buffer;
      src.connect(ctx.destination);
      src.start();
      src.onended = () => ctx.close();
    });

    // ì—°ìŠµ ë…¹ìŒ
    let pracCtx = null;
    let pracSource = null;
    let pracProcessor = null;
    let pracStream = null;

    const btnPracStart = document.getElementById('btn-prac-start');
    const btnPracStop = document.getElementById('btn-prac-stop');

    async function startPracticeRecording() {
      if (!currentSentKey) {
        alert("ë¨¼ì € ì—°ìŠµí•  ë¬¸ì¥ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
      }
      if (pracCtx) return;

      try {
        pracStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (e) {
        alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
        return;
      }
      pracCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (pracCtx.state === 'suspended') {
        await pracCtx.resume();
      }

      pracSource = pracCtx.createMediaStreamSource(pracStream);
      pracProcessor = pracCtx.createScriptProcessor(2048, 1, 1);
      pracSource.connect(pracProcessor);
      pracProcessor.connect(pracCtx.destination);

      userPoints.length = 0;

      pracProcessor.onaudioprocess = (e) => {
        const inbuf = e.inputBuffer.getChannelData(0);
        const tmp = new Float32Array(inbuf);
        const f0 = autoCorrelate(tmp, pracCtx.sampleRate, getFloor(), getCeil());
        userPoints.push(f0 > 0 ? f0 : 0);
        if (userPoints.length > 5000) userPoints.shift();
      };

      btnPracStart.disabled = true;
      btnPracStop.disabled = false;
    }

    function stopPracticeRecording() {
      if (pracProcessor) {
        pracProcessor.disconnect();
        pracProcessor.onaudioprocess = null;
        pracProcessor = null;
      }
      if (pracSource) {
        pracSource.disconnect();
        pracSource = null;
      }
      if (pracStream) {
        pracStream.getTracks().forEach(t => t.stop());
        pracStream = null;
      }
      if (pracCtx) {
        pracCtx.close();
        pracCtx = null;
      }
      btnPracStart.disabled = false;
      btnPracStop.disabled = true;
    }

    btnPracStart.addEventListener('click', startPracticeRecording);
    btnPracStop.addEventListener('click', stopPracticeRecording);
  </script>
</body>
</html>
