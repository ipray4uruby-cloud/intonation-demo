<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‹¤ì‹œê°„ ì–µì–‘(F0) ê³¡ì„  - Analyser ë²„ì „</title>
  <style>
    :root { --fg:#222; }
    body { font-family: system-ui, sans-serif; margin:16px; color:var(--fg);}
    h1 { font-size: 18px; margin-bottom: 8px;}
    #c { width:100%; height:260px; border:1px solid #ddd; border-radius:8px;}
    .row { display:flex; flex-wrap:wrap; gap:10px; margin:10px 0; align-items:center; }
    button { padding:8px 12px; border:1px solid #ccc; border-radius:8px; cursor:pointer; background:#f7f7f7;}
    button:disabled { opacity:0.4; cursor:default;}
    input[type=number]{width:90px;}
    small { color:#666; }
  </style>
</head>
<body>
  <h1>ğŸ¤ ì‹¤ì‹œê°„ ì–µì–‘(F0) ê³¡ì„  (ê°„ë‹¨ ë²„ì „)</h1>
  <div class="row">
    <button id="btn-start">Start</button>
    <button id="btn-stop" disabled>Stop</button>
    <span id="now">F0: -- Hz</span>
  </div>
  <div class="row">
    <label>ìµœì € F0(Hz):
      <input type="number" id="floor" value="75" min="20" max="300">
    </label>
    <label>ìµœê³  F0(Hz):
      <input type="number" id="ceil" value="400" min="100" max="800">
    </label>
    <small>â€» ë‚¨ì„± í™”ìë©´ 50â€“300, ì—¬ì„± í™”ìë©´ 75â€“500 ì •ë„ë¡œ ë°”ê¿” ë³´ì„¸ìš”.</small>
  </div>
  <canvas id="c" width="1232" height="260"></canvas>
  <p><small>ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸ìš© ë¯¸ë‹ˆ ë²„ì „ì…ë‹ˆë‹¤. ë¨¼ì € PC í¬ë¡¬ì—ì„œ í…ŒìŠ¤íŠ¸í•´ ë³´ì„¸ìš”.</small></p>

<script>
  // ===== Pitch ê³„ì‚°: ìë™ìƒê´€(auto-correlation) =====
  function autoCorrelate(buf, sampleRate, floor, ceil) {
    const N = buf.length;
    if (!N) return 0;

    // í‰ê·  ì œê±° + Hanning window
    let mean = 0;
    for (let i = 0; i < N; i++) mean += buf[i];
    mean /= N;
    for (let i = 0; i < N; i++) {
      buf[i] = (buf[i] - mean) * (0.5 - 0.5 * Math.cos(2 * Math.PI * i / (N - 1)));
    }

    // ì—ë„ˆì§€(RMS)ë¡œ ë¬´ì„±/ì €ì—ë„ˆì§€ êµ¬ê°„ ì œê±°
    let rms = 0;
    for (let i = 0; i < N; i++) rms += buf[i] * buf[i];
    rms = Math.sqrt(rms / N);
    if (rms < 0.002) return 0; // ë„ˆë¬´ ì‘ìœ¼ë©´ 0ìœ¼ë¡œ ì²˜ë¦¬ (ë…¸ì´ì¦ˆ/ë¬´ì„±)

    const maxLag = Math.floor(sampleRate / floor);
    const minLag = Math.floor(sampleRate / ceil);

    function xcorr(lag) {
      let s = 0;
      for (let i = 0; i < N - lag; i++) s += buf[i] * buf[i + lag];
      return s / (N - lag);
    }

    let bestLag = -1, best = 0;
    for (let lag = minLag; lag <= maxLag; lag++) {
      const c = xcorr(lag);
      if (c > best) { best = c; bestLag = lag; }
    }
    if (bestLag < 0 || best < 0.08) return 0; // ìƒê´€ê³„ìˆ˜ ë„ˆë¬´ ì‘ìœ¼ë©´ pitch ì—†ìŒ

    const c1 = xcorr(bestLag - 1), c2 = xcorr(bestLag), c3 = xcorr(bestLag + 1);
    const denom = (c1 - 2 * c2 + c3);
    let shift = 0;
    if (Math.abs(denom) > 1e-6) shift = 0.5 * (c1 - c3) / denom;

    const f0 = sampleRate / (bestLag + shift);
    return f0;
  }

  // ===== ìº”ë²„ìŠ¤ ì„¸íŒ… =====
  const canvas = document.getElementById('c');
  const g = canvas.getContext('2d');
  const maxPoints = 1000;
  const points = [];  // ìµœê·¼ F0 íˆìŠ¤í† ë¦¬

  function getFloor() {
    return +document.getElementById('floor').value || 75;
  }
  function getCeil() {
    return +document.getElementById('ceil').value || 400;
  }

  function mapF0(f, fmin, fmax) {
    const clamped = Math.max(fmin, Math.min(fmax, f));
    const r = (clamped - fmin) / (fmax - fmin);
    // y: ìœ„(ë†’ì€ F0) â†’ ì•„ë˜(ë‚®ì€ F0)
    return 244 - r * 220;
  }

  function drawFrame() {
    g.clearRect(0, 0, canvas.width, canvas.height);

    // ì¶•/í‹€
    g.strokeStyle = "#eee";
    g.beginPath();
    g.moveTo(48, 16);
    g.lineTo(48, 244);
    g.lineTo(1184, 244);
    g.stroke();

    const floor = getFloor();
    const ceil = getCeil();
    const ticks = [floor, (floor + ceil) / 2, ceil];

    ticks.forEach(t => {
      const y = mapF0(t, floor, ceil);
      g.strokeStyle = "#eee";
      g.beginPath();
      g.moveTo(48, y);
      g.lineTo(1184, y);
      g.stroke();
      g.fillStyle = "#666";
      g.font = "12px system-ui";
      g.fillText(Math.round(t) + " Hz", 8, y - 2);
    });

    // F0 ê³¡ì„ 
    const visible = points.slice(-maxPoints);
    if (!visible.length) return;

    g.strokeStyle = "#0a74da";
    g.lineWidth = 2;
    g.beginPath();
    let started = false;
    for (let i = 0; i < visible.length; i++) {
      const f0 = visible[i];
      if (f0 <= 0) { started = false; continue; } // ë¬´ì„±êµ¬ê°„ì€ ëŠì–´ì„œ ê·¸ë¦¼
      const x = 48 + (i / Math.max(visible.length - 1, 1)) * 1136;
      const y = mapF0(f0, floor, ceil);
      if (!started) { g.moveTo(x, y); started = true; }
      else { g.lineTo(x, y); }
    }
    g.stroke();
    g.lineWidth = 1;
  }

  // ===== ì˜¤ë””ì˜¤/Analyser ì„¸íŒ… =====
  let audioCtx = null;
  let analyser = null;
  let stream = null;
  let dataArray = null;
  let animId = null;

  const nowEl = document.getElementById('now');
  const btnStart = document.getElementById('btn-start');
  const btnStop = document.getElementById('btn-stop');

  async function start() {
    if (audioCtx) return; // ì´ë¯¸ ì‹¤í–‰ ì¤‘

    try {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (e) {
      alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
      console.error(e);
      return;
    }

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") {
      await audioCtx.resume();
    }

    const source = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    source.connect(analyser);

    dataArray = new Float32Array(analyser.fftSize);

    function loop() {
      animId = requestAnimationFrame(loop);
      analyser.getFloatTimeDomainData(dataArray);
      const floor = getFloor();
      const ceil = getCeil();
      const buf = new Float32Array(dataArray); // autoCorrelate ì•ˆì—ì„œ ìˆ˜ì •í•˜ë¯€ë¡œ ë³µì‚¬
      const f0 = autoCorrelate(buf, audioCtx.sampleRate, floor, ceil);
      points.push(f0 > 0 ? f0 : 0);
      if (points.length > 5000) points.shift();
      nowEl.textContent = "F0: " + (f0 ? Math.round(f0) + " Hz" : "-- Hz");
      drawFrame();
    }

    loop();
    btnStart.disabled = true;
    btnStop.disabled = false;
  }

  function stop() {
    if (animId) {
      cancelAnimationFrame(animId);
      animId = null;
    }
    if (analyser) {
      analyser.disconnect();
      analyser = null;
    }
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    if (audioCtx) {
      audioCtx.close();
      audioCtx = null;
    }
    nowEl.textContent = "F0: -- Hz";
    btnStart.disabled = false;
    btnStop.disabled = true;
  }

  btnStart.addEventListener('click', start);
  btnStop.addEventListener('click', stop);

  // ì²˜ìŒ ë¡œë”© ì‹œ ë¹ˆ ì¶• ê·¸ë¦¬ê¸°
  drawFrame();
</script>
</body>
</html>
