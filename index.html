<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ¤ í•œêµ­ì–´ ì–µì–‘ ì›¹ì•± (ë°ëª¨)</title>
<style>
  :root { --fg:#222; }
  body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin:16px; color:var(--fg);}
  h1 { font-size: 20px; margin-bottom: 8px; display:flex; align-items:center; gap:6px;}
  h2 { font-size: 16px; margin:16px 0 8px;}
  #c { width:100%; height:260px; border:1px solid #ddd; border-radius:12px;}
  .row { display:flex; flex-wrap:wrap; gap:10px; margin:10px 0; align-items:center;}
  button { padding:8px 12px; border:1px solid #ccc; border-radius:999px; cursor:pointer; background:#fff; font-size:14px;}
  button[disabled]{opacity:0.45; cursor:default;}
  input[type=number]{width:90px; padding:4px 6px; border-radius:6px; border:1px solid #ccc; font-size:13px;}
  .tabs { display:flex; gap:8px; margin:16px 0;}
  .tab-btn { padding:8px 16px; border-radius:999px; border:1px solid #ccc; cursor:pointer; background:#f7f7f7;}
  .tab-btn.active { background:#0a74da; color:#fff; border-color:#0a74da;}
  .tab { display:none; }
  .tab.active { display:block; }
  #feedback { margin-top:8px; font-size:14px; color:#333; }
  .wh-button { padding:6px 12px; border-radius:999px; border:1px solid #ddd; background:#fafafa; font-size:13px;}
  .wh-button.active { background:#0a74da; color:#fff; border-color:#0a74da;}
  .variant-button { padding:6px 12px; border-radius:999px; border:1px solid #ddd; background:#f3f3f3; font-size:13px;}
  .variant-button.active { background:#ff9500; color:#fff; border-color:#ff9500;}
  .meta { font-size:12px; color:#666; }
  .legend { font-size:12px; margin-top:6px; display:flex; flex-wrap:wrap; gap:12px;}
  .legend span { display:flex; align-items:center; gap:4px; }
  .legend-color { width:10px; height:10px; border-radius:50%; }
  .pill-label { font-size:12px; padding:2px 8px; border-radius:999px; background:#f0f0f0; }
</style>

<body>
<h1>ğŸ¤ <span>í•œêµ­ì–´ ì–µì–‘ ì›¹ì•± (ë°ëª¨)</span></h1>

<div class="tabs">
  <button class="tab-btn active" data-tab="live">ì‹¤ì‹œê°„ F0 ë³´ê¸°</button>
  <button class="tab-btn" data-tab="practice">ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ</button>
</div>

<!-- ê³µí†µ: F0 ìº”ë²„ìŠ¤ -->
<canvas id="c" width="1200" height="260"></canvas>
<div class="legend">
  <span><span class="legend-color" style="background:#0a74da;"></span>ì‹¤ì‹œê°„/ë‚´ ë°œí™” F0</span>
  <span><span class="legend-color" style="background:#ff6666;"></span>ì—°ìŠµ ëª¨ë“œ: ì´ë²ˆ ë…¹ìŒ F0</span>
  <span><span class="legend-color" style="background:#888888;"></span>ì—°ìŠµ ëª¨ë“œ: ëª¨ë²” ë°œí™” F0</span>
</div>
<div class="row meta">
  <div>í˜„ì¬ F0: <span id="now">-- Hz</span></div>
  <div style="margin-left:auto; display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
    <span>Floor(Hz)</span>
    <input id="floor" type="number" value="75" min="40" max="200">
    <span>Ceiling(Hz)</span>
    <input id="ceil" type="number" value="400" min="200" max="800">
  </div>
</div>

<!-- íƒ­ 1: ì‹¤ì‹œê°„ F0 ë³´ê¸° -->
<div class="tab active" id="tab-live">
  <h2>â‘  ì‹¤ì‹œê°„ ì–µì–‘(F0) ê³¡ì„  ë³´ê¸°</h2>
  <div class="row">
    <button id="start">Start</button>
    <button id="stop" disabled>Stop</button>
  </div>
  <p class="meta">
    Startë¥¼ ëˆ„ë¥´ê³  ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•œ ë’¤, ë§ì„ í•´ ë³´ì„¸ìš”. íŒŒë€ ì„ ì´ ì‹¤ì‹œê°„ F0 ê³¡ì„ ì…ë‹ˆë‹¤.<br>
    (iPhone/Safariì—ì„œë„ ë™ì‘í•˜ë„ë¡ AudioContext ì¬ê°œ(resume) ì²˜ë¦¬ í¬í•¨)
  </p>
</div>

<!-- íƒ­ 2: ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ -->
<div class="tab" id="tab-practice">
  <h2>â‘¡ ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ (íŒì •/ì„¤ëª… ì–µì–‘ ë¹„êµ)</h2>

  <!-- (1) ì˜ë¬¸ì‚¬ ì„ íƒ -->
  <div class="row">
    <span class="pill-label">ì˜ë¬¸ì‚¬ ì„ íƒ</span>
    <button class="wh-button" data-id="nugu">ëˆ„êµ¬</button>
    <button class="wh-button" data-id="eodi">ì–´ë””</button>
    <button class="wh-button" data-id="mwo">ë­</button>
    <button class="wh-button" data-id="eonje">ì–¸ì œ</button>
  </div>

  <!-- (2) ì–µì–‘ ìœ í˜• ì„ íƒ -->
  <div class="row">
    <span class="pill-label">ì–µì–‘ ìœ í˜•</span>
    <button class="variant-button" data-variant="yn">íŒì • ì˜ë¬¸ë¬¸ (Y/N)</button>
    <button class="variant-button" data-variant="wh">ì„¤ëª… ì˜ë¬¸ë¬¸ (WH)</button>
  </div>

  <!-- (3) ë¬¸ì¥ í‘œì‹œ -->
  <div class="row">
    <div id="sent-text" class="meta">ì˜ë¬¸ì‚¬ì™€ ì–µì–‘ ìœ í˜•ì„ ì„ íƒí•˜ë©´ ë¬¸ì¥ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>

  <!-- (4) ì¬ìƒ/ë…¹ìŒ -->
  <div class="row">
    <button id="play-native" disabled>ëª¨ë²” ë°œìŒ ì¬ìƒ</button>
    <button id="record-once" disabled>ë‚´ ë°œìŒ ë…¹ìŒ(1íšŒ)</button>
  </div>

  <p class="meta">
    ì ˆì°¨: â‘  ì˜ë¬¸ì‚¬ë¥¼ ì„ íƒí•˜ê³  â‘¡ íŒì •/ì„¤ëª… ì–µì–‘ì„ ì„ íƒí•œ ë’¤ â‘¢ ëª¨ë²” ë°œìŒì„ ë“£ê³  â‘£ ë‚´ ë°œí™”ë¥¼ ë…¹ìŒí•©ë‹ˆë‹¤.<br>
    íšŒìƒ‰ ì„ (ëª¨ë²”)ê³¼ ë¹¨ê°„ ì„ (ë‚´ ë°œí™”)ì˜ F0 ê³¡ì„ ì„ ë¹„êµí•˜ê³ , ê°„ë‹¨í•œ í”¼ë“œë°±ì´ ì•„ë˜ì— í‘œì‹œë©ë‹ˆë‹¤.
  </p>

  <div id="feedback" class="meta"></div>

  <hr style="margin:16px 0; border:none; border-top:1px dashed #ddd;">

  <h2>â‘¢ ì—°êµ¬ìš© ë°ì´í„° ì €ì¥ (ë¡œì»¬ë¡œ ë‹¤ìš´ë¡œë“œ)</h2>
  <p class="meta">
    ì•„ë˜ ê¸°ëŠ¥ì€ <strong>ë¸Œë¼ìš°ì €ì—ì„œë§Œ ë¡œì»¬ íŒŒì¼ë¡œ ì €ì¥</strong>í•©ë‹ˆë‹¤. GitHub ì„œë²„ì—ëŠ” ìë™ìœ¼ë¡œ ì—…ë¡œë“œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
  </p>

  <div class="row">
    <button id="download-audio" disabled>ì´ë²ˆ ë…¹ìŒ ìŒì„± ë‹¤ìš´ë¡œë“œ (WAV)</button>
    <button id="download-f0" disabled>F0 ë°ì´í„° ë‹¤ìš´ë¡œë“œ (JSON)</button>
  </div>

  <div class="row">
    <button id="save-before" disabled>ì´ë²ˆ ë…¹ìŒì„ Beforeë¡œ ì €ì¥</button>
    <button id="save-after" disabled>ì´ë²ˆ ë…¹ìŒì„ Afterë¡œ ì €ì¥</button>
  </div>

  <p class="meta">
    - Before/Afterë¡œ ì €ì¥í•˜ë©´, F0 JSONì— ê°™ì´ í¬í•¨ë©ë‹ˆë‹¤.<br>
    - íŒŒì¼ëŸ¿ ì°¸ê°€ìëŠ” ë‚´ë ¤ë°›ì€ íŒŒì¼ì„ ì´ë©”ì¼ì´ë‚˜ êµ¬ê¸€ë“œë¼ì´ë¸Œë¡œ ì—°êµ¬ìì—ê²Œ ì œì¶œí•˜ë©´ ë©ë‹ˆë‹¤.
  </p>
</div>

<script>
// ====== ì—°ìŠµ ë¬¸ì¥/íŒŒì¼ ì„¤ì • (4 ì˜ë¬¸ì‚¬ Ã— 2 ì–µì–‘) ======
const QUESTION_CONFIG = {
  nugu: {
    label: "ëˆ„êµ¬",
    sentence: "ëˆ„êµ¬ ë§Œë‚˜ìš”?",
    audio: {
      yn: "audio/nugu_yn.wav",
      wh: "audio/nugu_wh.wav"
    }
  },
  eodi: {
    label: "ì–´ë””",
    sentence: "ì–´ë”” ê°€ìš”?",
    audio: {
      yn: "audio/eodi_yn.wav",
      wh: "audio/eodi_wh.wav"
    }
  },
  mwo: {
    label: "ë­",
    sentence: "ë­ í•´ìš”?",
    audio: {
      yn: "audio/mwo_yn.wav",
      wh: "audio/mwo_wh.wav"
    }
  },
  eonje: {
    label: "ì–¸ì œ",
    sentence: "ì–¸ì œ ë§Œë‚˜ìš”?",
    audio: {
      yn: "audio/eonje_yn.wav",
      wh: "audio/eonje_wh.wav"
    }
  }
};

// ====== ê³µí†µ ë³€ìˆ˜ ë° ìœ í‹¸ ======
let audioCtx, source, processor, stream, animId;
const c = document.getElementById('c'), g = c.getContext('2d');
const livePoints = [];
const practiceUserPoints = [];
const practiceNativePoints = [];
const maxPoints = 1000;

let lastUserFloat = null;
let lastUserSampleRate = null;
let lastUserTrack = null;
let beforeTrack = null;
let afterTrack = null;

function getFloor() { return +document.getElementById('floor').value || 75; }
function getCeil()  { return +document.getElementById('ceil').value || 400; }

function autoCorrelate(buf, sr, floor=75, ceil=400){
  const N = buf.length;
  let mean=0; for(let i=0;i<N;i++) mean+=buf[i]; mean/=N;
  for(let i=0;i<N;i++) buf[i]=(buf[i]-mean)*(0.5-0.5*Math.cos(2*Math.PI*i/(N-1)));
  const maxLag=Math.floor(sr/floor), minLag=Math.floor(sr/ceil);
  let rms=0; for(let i=0;i<N;i++) rms+=buf[i]*buf[i]; rms=Math.sqrt(rms/N);
  if(rms<0.01) return 0;
  const xcorr=(lag)=>{let s=0;for(let i=0;i<N-lag;i++) s+=buf[i]*buf[i+lag];return s/(N-lag);}
  let bestLag=-1,best=0;
  for(let lag=minLag;lag<=maxLag;lag++){const c=xcorr(lag);if(c>best){best=c;bestLag=lag;}}
  if(bestLag<0||best<0.1) return 0;
  const c1=xcorr(bestLag-1), c2=xcorr(bestLag), c3=xcorr(bestLag+1);
  const denom=(c1-2*c2+c3); let shift=0;
  if(Math.abs(denom)>1e-6) shift=0.5*(c1-c3)/denom;
  return sr/(bestLag+shift);
}

function computeF0Track(floatBuf, sr, frameSize=2048, hopSize=512){
  const floor = getFloor(), ceil = getCeil();
  const len = floatBuf.length;
  const f0s = [];
  for(let start=0; start+frameSize <= len; start += hopSize){
    const frame = floatBuf.slice(start, start+frameSize);
    const f0 = autoCorrelate(new Float32Array(frame), sr, floor, ceil);
    f0s.push(f0 > 0 ? f0 : 0);
  }
  return f0s;
}

function draw(){
  g.clearRect(0,0,c.width,c.height);
  const floor = getFloor(), ceil = getCeil();

  g.strokeStyle="#eee";
  g.beginPath(); g.moveTo(48,16); g.lineTo(48,244); g.lineTo(1184,244); g.stroke();
  [floor,(floor+ceil)/2,ceil].forEach(t=>{
    const y=mapF0(t,floor,ceil);
    g.strokeStyle="#eee"; g.beginPath(); g.moveTo(48,y); g.lineTo(1184,y); g.stroke();
    g.fillStyle="#666"; g.font="12px system-ui"; g.fillText(Math.round(t)+" Hz",8,y-2);
  });

  drawTrack(livePoints, "#0a74da", floor, ceil);
  drawTrack(practiceNativePoints, "#888888", floor, ceil);
  drawTrack(practiceUserPoints, "#ff6666", floor, ceil);

  animId = requestAnimationFrame(draw);
}

function mapF0(f,fmin,fmax){
  const clamped = Math.max(fmin,Math.min(fmax,f));
  const r = (clamped-fmin)/(fmax-fmin);
  return 244 - r*220;
}

function drawTrack(arr, color, floor, ceil){
  if(!arr.length) return;
  g.strokeStyle = color; g.beginPath();
  const visible = arr.slice(-maxPoints);
  let started=false;
  for(let i=0;i<visible.length;i++){
    const f0 = visible[i];
    if(f0<=0){ started=false; continue; }
    const x = 48+(i/Math.max(visible.length-1,1))*1136;
    const y = mapF0(f0,floor,ceil);
    if(!started){ g.moveTo(x,y); started=true; }
    else{ g.lineTo(x,y); }
  }
  g.stroke();
}

// íƒ­ ì „í™˜
const tabBtns = document.querySelectorAll('.tab-btn');
const tabs = {
  live: document.getElementById('tab-live'),
  practice: document.getElementById('tab-practice')
};
tabBtns.forEach(btn=>{
  btn.onclick = ()=>{
    tabBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tabId = btn.dataset.tab;
    Object.keys(tabs).forEach(id=>{
      tabs[id].classList.toggle('active', id===tabId);
    });
  };
});

// ===== ì‹¤ì‹œê°„ ëª¨ë“œ =====
const startBtn=document.getElementById('start'),
      stopBtn=document.getElementById('stop');

async function startLive(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({audio:true});
  }catch(e){
    alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ì„¤ì •ì—ì„œ ì´ ì‚¬ì´íŠ¸ì˜ ë§ˆì´í¬ ì ‘ê·¼ì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.");
    return;
  }

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === "suspended") {
    try { await audioCtx.resume(); } catch (e) { console.error(e); }
  }

  source = audioCtx.createMediaStreamSource(stream);
  processor = audioCtx.createScriptProcessor(2048,1,1);
  source.connect(processor);
  processor.connect(audioCtx.destination);

  processor.onaudioprocess = (e)=>{
    const inbuf = e.inputBuffer.getChannelData(0);
    const f0 = autoCorrelate(new Float32Array(inbuf), audioCtx.sampleRate, getFloor(), getCeil());
    livePoints.push(f0>0?f0:0);
    if(livePoints.length>5000) livePoints.shift();
    document.getElementById('now').textContent = (f0?Math.round(f0):"--")+" Hz";
  };

  if(!animId) draw();
  startBtn.disabled=true; stopBtn.disabled=false;
}

function stopLive(){
  if(processor){processor.disconnect();processor.onaudioprocess=null;}
  if(source) source.disconnect();
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
  if(audioCtx){audioCtx.close();audioCtx=null;}
  startBtn.disabled=false; stopBtn.disabled=true;
  document.getElementById('now').textContent = "-- Hz";
}
startBtn.onclick=startLive;
stopBtn.onclick=stopLive;

// ===== ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ =====
const whButtons = document.querySelectorAll('.wh-button');
const variantButtons = document.querySelectorAll('.variant-button');
const sentText = document.getElementById('sent-text');
const playNativeBtn = document.getElementById('play-native');
const recordOnceBtn = document.getElementById('record-once');
const feedbackEl = document.getElementById('feedback');

const downloadAudioBtn = document.getElementById('download-audio');
const downloadF0Btn = document.getElementById('download-f0');
const saveBeforeBtn = document.getElementById('save-before');
const saveAfterBtn = document.getElementById('save-after');

let practiceAudioCtx = null;
let nativeAudioBuffer = null;

let currentQuestionId = null;
let currentVariant = null;

function setActiveButton(group, target){
  group.forEach(b=>b.classList.toggle('active', b===target));
}

// ì˜ë¬¸ì‚¬ ì„ íƒ
whButtons.forEach(btn=>{
  btn.onclick = ()=>{
    const id = btn.dataset.id;
    currentQuestionId = id;
    setActiveButton(whButtons, btn);

    // ê¸°ë³¸ìœ¼ë¡œ íŒì • ì˜ë¬¸ë¬¸ ì„ íƒ
    currentVariant = "yn";
    setActiveButton(variantButtons, [...variantButtons].find(b=>b.dataset.variant==="yn"));

    loadNative();
  };
});

// ì–µì–‘ ìœ í˜• ì„ íƒ
variantButtons.forEach(btn=>{
  btn.onclick = ()=>{
    if(!currentQuestionId){
      alert("ë¨¼ì € ì˜ë¬¸ì‚¬ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
      return;
    }
    currentVariant = btn.dataset.variant;
    setActiveButton(variantButtons, btn);
    loadNative();
  };
});

// ëª¨ë²” ìŒì„± ë¡œë“œ + ë¬¸ì¥ í‘œì‹œ + ëª¨ë²” F0 ê³„ì‚°
async function loadNative(){
  const q = QUESTION_CONFIG[currentQuestionId];
  if(!q || !currentVariant){
    feedbackEl.textContent = "ì˜ë¬¸ì‚¬ì™€ ì–µì–‘ ìœ í˜•ì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.";
    return;
  }
  const audioPath = q.audio[currentVariant];
  const sentence = q.sentence;
  sentText.textContent = sentence + "  (" + (currentVariant==="yn" ? "íŒì • ì˜ë¬¸ë¬¸" : "ì„¤ëª… ì˜ë¬¸ë¬¸") + ")";

  feedbackEl.textContent = "ëª¨ë²” ìŒì„±ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
  try{
    if(!practiceAudioCtx) practiceAudioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const res = await fetch(audioPath);
    const arrBuf = await res.arrayBuffer();
    nativeAudioBuffer = await practiceAudioCtx.decodeAudioData(arrBuf);

    const nativeFloat = nativeAudioBuffer.getChannelData(0);
    const nativeTrack = computeF0Track(nativeFloat, nativeAudioBuffer.sampleRate);
    practiceNativePoints.length = 0;
    practiceNativePoints.push(...nativeTrack);

    feedbackEl.textContent = "ëª¨ë²” ìŒì„±ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. 'ëª¨ë²” ë°œìŒ ì¬ìƒ'ì„ ëˆ„ë¥¸ ë’¤, 'ë‚´ ë°œìŒ ë…¹ìŒ'ì„ í•´ ë³´ì„¸ìš”.";
    playNativeBtn.disabled = false;
    recordOnceBtn.disabled = false;
  }catch(e){
    console.error(e);
    feedbackEl.textContent = "ëª¨ë²” ìŒì„±ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. audio í´ë”ì˜ íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.";
    playNativeBtn.disabled = true;
    recordOnceBtn.disabled = true;
  }
}

playNativeBtn.onclick = ()=>{
  if(!nativeAudioBuffer || !practiceAudioCtx) return;
  const src = practiceAudioCtx.createBufferSource();
  src.buffer = nativeAudioBuffer;
  src.connect(practiceAudioCtx.destination);
  src.start();
};

// 1íšŒ ë…¹ìŒ
recordOnceBtn.onclick = async ()=>{
  feedbackEl.textContent = "ë…¹ìŒì„ ì‹œì‘í•©ë‹ˆë‹¤. 3ì´ˆ ë™ì•ˆ ë¬¸ì¥ì„ ë§í•´ ì£¼ì„¸ìš”.";
  let recStream;
  try{
    recStream = await navigator.mediaDevices.getUserMedia({audio:true});
  }catch(e){
    alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ì„¤ì •ì—ì„œ ì´ ì‚¬ì´íŠ¸ì˜ ë§ˆì´í¬ ì ‘ê·¼ì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.");
    return;
  }
  const recCtx = new (window.AudioContext||window.webkitAudioContext)();
  const recSource = recCtx.createMediaStreamSource(recStream);
  const recProcessor = recCtx.createScriptProcessor(2048,1,1);
  const chunks = [];
  recSource.connect(recProcessor);
  recProcessor.connect(recCtx.destination);

  let recording = true;
  setTimeout(()=>{ recording=false; }, 3000);

  recProcessor.onaudioprocess = (e)=>{
    if(!recording){
      recProcessor.disconnect(); recSource.disconnect();
      recStream.getTracks().forEach(t=>t.stop());
      const sr = recCtx.sampleRate;
      recCtx.close();

      processPractice(nativeAudioBuffer, chunks, sr);
      recProcessor.onaudioprocess = null;
      return;
    }
    const buf = e.inputBuffer.getChannelData(0);
    chunks.push(new Float32Array(buf));
  };
};

function processPractice(nativeBuf, userChunks, userSr){
  if(!nativeBuf){
    feedbackEl.textContent = "ëª¨ë²” ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì˜ë¬¸ì‚¬ì™€ ì–µì–‘ ìœ í˜•ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
    return;
  }
  if(!userChunks.length){
    feedbackEl.textContent = "ë…¹ìŒëœ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
    return;
  }

  const userLength = userChunks.reduce((s,cur)=>s+cur.length,0);
  const userFloat = new Float32Array(userLength);
  let offset = 0;
  for(const ch of userChunks){
    userFloat.set(ch, offset); offset += ch.length;
  }

  const nativeFloat = nativeBuf.getChannelData(0);
  const nativeTrack = computeF0Track(nativeFloat, nativeBuf.sampleRate);
  const userTrack = computeF0Track(userFloat, userSr);

  practiceNativePoints.length = 0;
  practiceUserPoints.length = 0;
  practiceNativePoints.push(...nativeTrack);
  practiceUserPoints.push(...userTrack);

  lastUserFloat = userFloat;
  lastUserSampleRate = userSr;
  lastUserTrack = userTrack;

  downloadAudioBtn.disabled = false;
  downloadF0Btn.disabled = false;
  saveBeforeBtn.disabled = false;
  saveAfterBtn.disabled = false;

  const lastN = 10;
  const u = userTrack.slice(-lastN).filter(x=>x>0);
  const n = nativeTrack.slice(-lastN).filter(x=>x>0);
  let msg = "ë°œí™”ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ë˜í”„ì—ì„œ íšŒìƒ‰(ëª¨ë²”)ê³¼ ë¹¨ê°„ ì„ (ë‚´ ë°œí™”)ì„ ë¹„êµí•´ ë³´ì„¸ìš”.";
  if(u.length && n.length){
    const uStart = u[0], uEnd = u[u.length-1];
    const nStart = n[0], nEnd = n[n.length-1];
    const uSlope = uEnd - uStart;
    const nSlope = nEnd - nStart;
    if(nSlope > 0 && uSlope <= 0){
      msg += " (ì´ íŒ¨í„´ì€ íŒì • ì˜ë¬¸ë¬¸ ì–µì–‘ì…ë‹ˆë‹¤. ë¬¸ë§ ì–µì–‘ì„ ì¡°ê¸ˆ ë” ì˜¬ë ¤ ë³´ì„¸ìš”.)";
    }else if(nSlope < 0 && uSlope >= 0){
      msg += " (ì´ íŒ¨í„´ì€ ì„¤ëª… ì˜ë¬¸ë¬¸ ì–µì–‘ì…ë‹ˆë‹¤. ë¬¸ë§ì„ ìì—°ìŠ¤ëŸ½ê²Œ ë‚´ë ¤ ë³´ì„¸ìš”.)";
    }else{
      msg += " ë¬¸ë§ ì–µì–‘ì˜ ë°©í–¥ì€ ëª¨ë²”ê³¼ ë¹„ìŠ·í•©ë‹ˆë‹¤. ì „ì²´ ë†’ë‚®ì´ ëŒ€ë¹„ë¥¼ ì¡°ê¸ˆ ë” í‚¤ì›Œ ë³´ì„¸ìš”.";
    }
  }
  feedbackEl.textContent = msg;
  document.getElementById('now').textContent = "-- Hz";
}

// ===== ë‹¤ìš´ë¡œë“œ & Before/After =====
function float32ToWavBlob(float32, sampleRate){
  const buffer = new ArrayBuffer(44 + float32.length * 2);
  const view = new DataView(buffer);

  function writeString(offset, string){
    for(let i=0;i<string.length;i++){
      view.setUint8(offset+i, string.charCodeAt(i));
    }
  }

  const numChannels = 1;
  const bitsPerSample = 16;
  const byteRate = sampleRate * numChannels * bitsPerSample/8;
  const blockAlign = numChannels * bitsPerSample/8;

  writeString(0, 'RIFF');
  view.setUint32(4, 36 + float32.length * 2, true);
  writeString(8, 'WAVE');
  writeString(12, 'fmt ');
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true);
  view.setUint16(22, numChannels, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, byteRate, true);
  view.setUint16(32, blockAlign, true);
  view.setUint16(34, bitsPerSample, true);

  writeString(36, 'data');
  view.setUint32(40, float32.length * 2, true);

  let offset = 44;
  for(let i=0;i<float32.length;i++){
    let s = Math.max(-1, Math.min(1, float32[i]));
    view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
    offset += 2;
  }

  return new Blob([view], {type:'audio/wav'});
}

function triggerDownload(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

downloadAudioBtn.onclick = ()=>{
  if(!lastUserFloat || !lastUserSampleRate){
    alert("ë‹¤ìš´ë¡œë“œí•  ë…¹ìŒì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë…¹ìŒí•´ ì£¼ì„¸ìš”.");
    return;
  }
  const blob = float32ToWavBlob(lastUserFloat, lastUserSampleRate);
  triggerDownload(blob, 'intonation_user_recording.wav');
};

downloadF0Btn.onclick = ()=>{
  if(!lastUserTrack){
    alert("F0 ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë…¹ìŒí•´ ì£¼ì„¸ìš”.");
    return;
  }
  const payload = {
    sampleRate: lastUserSampleRate,
    questionId: currentQuestionId,
    variant: currentVariant,
    f0Track_current: lastUserTrack,
    f0Track_before: beforeTrack || null,
    f0Track_after: afterTrack || null,
    note: "ê° ë°°ì—´ì˜ ê°’ì€ í”„ë ˆì„ ë‹¨ìœ„ F0(Hz)ì…ë‹ˆë‹¤. 0ì€ ë¬´ì„±/ê²€ì¶œ ì‹¤íŒ¨ êµ¬ê°„ì…ë‹ˆë‹¤."
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  triggerDownload(blob, 'intonation_f0_data.json');
};

saveBeforeBtn.onclick = ()=>{
  if(!lastUserTrack){
    alert("ë¨¼ì € ë…¹ìŒì„ í•´ ì£¼ì„¸ìš”.");
    return;
  }
  beforeTrack = [...lastUserTrack];
  alert("ì´ë²ˆ ë…¹ìŒì„ Beforeë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.");
};

saveAfterBtn.onclick = ()=>{
  if(!lastUserTrack){
    alert("ë¨¼ì € ë…¹ìŒì„ í•´ ì£¼ì„¸ìš”.");
    return;
  }
  afterTrack = [...lastUserTrack];
  alert("ì´ë²ˆ ë…¹ìŒì„ Afterë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.");
};

draw();
</script>
</body>
</html>
