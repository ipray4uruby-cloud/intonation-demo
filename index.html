<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì‹¤ì‹œê°„ ì–µì–‘(STARTâ€“STOP í›„ ì „ì²´ ë¶„ì„)</title>
<style>
  :root { --fg:#111; --muted:#666; }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
    margin:16px;
    color:var(--fg);
  }
  h1{font-size:18px;margin:0 0 8px}
  .row{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    margin:10px 0
  }
  button{
    padding:9px 14px;
    border:1px solid #ccc;
    border-radius:10px;
    background:#fafafa;
    cursor:pointer
  }
  button[disabled]{opacity:.5;cursor:not-allowed}
  input[type=number]{width:86px}
  #c{
    width:100%;
    height:260px;
    border:1px solid #e2e2e2;
    border-radius:12px;
    background:#fff
  }
  #status{color:var(--muted)}
</style>

<h1>ğŸ¤ STARTâ€“STOP í›„ ì „ì²´ ì–µì–‘(F0) ê³¡ì„ </h1>
<div class="row">
  <button id="start">Start</button>
  <button id="stop" disabled>Stop</button>
  <button id="reset" disabled>Reset</button>
  <label>Floor(Hz) <input id="floor" type="number" value="75" min="40" max="200"></label>
  <label>Ceiling(Hz) <input id="ceil" type="number" value="400" min="200" max="800"></label>
  <label>Smoothing <input id="smooth" type="number" value="5" min="1" max="21" step="2"></label>
</div>
<canvas id="c" width="1200" height="260"></canvas>
<div class="row">
  <div id="now">F0: -- Hz</div>
  <small id="status">ì¤€ë¹„ ì™„ë£Œ</small>
</div>

<script>
let mediaStream, mediaRecorder, chunks = [], audioCtx;
const startBtn = document.getElementById('start');
const stopBtn  = document.getElementById('stop');
const resetBtn = document.getElementById('reset');
const c = document.getElementById('c'), g = c.getContext('2d');

function setStatus(t){
  document.getElementById('status').textContent = " Â· " + t;
}

async function ensureAudioContext(){
  if(!audioCtx)
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === 'suspended'){
    try { await audioCtx.resume(); } catch(e){}
  }
  return audioCtx;
}

// ===== Pitch tracking (autocorrelation) =====
function hannWindow(N){
  const w = new Float32Array(N);
  for(let i=0;i<N;i++)
    w[i] = 0.5 - 0.5*Math.cos(2*Math.PI*i/(N-1));
  return w;
}
const ACF_WINDOW = hannWindow(2048);

function f0_from_frame(buf, sr, floor, ceil){
  // center-clip + AC
  const N = buf.length;
  let mean = 0;
  for(let i=0;i<N;i++) mean += buf[i];
  mean /= N;

  let rms = 0;
  for(let i=0;i<N;i++){
    const v = (buf[i]-mean)*ACF_WINDOW[i%ACF_WINDOW.length];
    rms += v*v;
    buf[i] = v;
  }
  rms = Math.sqrt(rms/N);

  // â˜… ì„ê³„ê°’ ì›ë˜ëŒ€ë¡œ ë³µêµ¬
  if(rms < 0.005) return 0;

  const minLag = Math.floor(sr/ceil);
  const maxLag = Math.floor(sr/floor);
  let bestLag = -1, best = 0;

  // normalized autocorrelation
  let denom0 = 0;
  for(let i=0;i<N;i++) denom0 += buf[i]*buf[i];

  for(let lag=minLag; lag<=maxLag; lag++){
    let s=0, denom1=0;
    for(let i=0;i<N-lag;i++){
      const a = buf[i], b = buf[i+lag];
      s += a*b;
      denom1 += b*b;
    }
    const nccf = (denom1>1e-9) ? s/Math.sqrt(denom0*denom1) : 0;
    if(nccf > best){
      best = nccf;
      bestLag = lag;
    }
  }

  // â˜… ìƒê´€ê³„ìˆ˜ ì„ê³„ê°’ë„ ì›ë˜ê°’ 0.3ìœ¼ë¡œ ë³µêµ¬
  if(bestLag < 0 || best < 0.3) return 0;

  // parabolic interpolation around bestLag
  const ac = (lag)=>{
    let s=0;
    for(let i=0;i<N-lag;i++) s += buf[i]*buf[i+lag];
    return s;
  };
  const c1 = ac(bestLag-1),
        c2 = ac(bestLag),
        c3 = ac(bestLag+1);
  const denom = (c1 - 2*c2 + c3);
  let shift = 0;
  if(Math.abs(denom) > 1e-6)
    shift = 0.5*(c1-c3)/denom;

  return sr/(bestLag+shift);
}

function medianSmooth(arr, k=5){
  if(k<2) return arr;
  const h = Math.floor(k/2), out = new Array(arr.length);
  for(let i=0;i<arr.length;i++){
    const s = Math.max(0,i-h), e = Math.min(arr.length,i+h+1);
    const slice = arr.slice(s,e).filter(v=>v>0).sort((a,b)=>a-b);
    out[i] = slice.length ? slice[Math.floor(slice.length/2)] : 0;
  }
  return out;
}

// â˜… ì¡°ê¸ˆ ë” ì´˜ì´˜í•˜ê²Œ ìƒ˜í”Œë§í•´ì„œ â€œê°€ë¡œ í­â€ì´ ì—¬ìœ  ìˆê²Œ ë³´ì´ë„ë¡
function trackPitch(signal, sr, floor, ceil, frameMs=25, hopMs=5){
  const frame = Math.round(sr*frameMs/1000),
        hop   = Math.round(sr*hopMs/1000);
  const out = [];
  const buf = new Float32Array(frame);

  for(let start=0; start+frame<=signal.length; start+=hop){
    buf.set(sign
