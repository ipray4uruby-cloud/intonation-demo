<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì‹¤ì‹œê°„ ì–µì–‘(STARTâ€“STOP í›„ ì „ì²´ ë¶„ì„)</title>

<style>
  :root { --fg:#111; --muted:#666; }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
    margin:16px;
    color:var(--fg);
  }
  h1{font-size:18px;margin:0 0 8px}
  h2{font-size:16px;margin:16px 0 6px}
  p{margin:4px 0 8px}
  .row{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    margin:10px 0;
  }
  button{
    padding:9px 14px;
    border:1px solid #ccc;
    border-radius:10px;
    background:#fafafa;
    cursor:pointer;
    font-size:14px;
  }
  button[disabled]{opacity:.5;cursor:not-allowed}
  input[type=number]{width:86px}
  #c, #cPractice{
    width:100%;
    height:260px;
    border:1px solid #e2e2e2;
    border-radius:12px;
    background:#fff;
  }
  #status, #practiceStatus{color:var(--muted); font-size:13px;}
  .sent-btn.active{
    background:#0a74da;
    color:#fff;
    border-color:#0a74da;
  }
</style>

<!-- â‘  STARTâ€“STOP ì „ì²´ ì–µì–‘ ê³¡ì„  -->
<h1>ğŸ¤ STARTâ€“STOP í›„ ì „ì²´ ì–µì–‘(F0) ê³¡ì„ </h1>

<div class="row">
  <button id="start">Start</button>
  <button id="stop" disabled>Stop</button>
  <button id="reset" disabled>Reset</button>
  <label>Floor(Hz) <input id="floor" type="number" value="75" min="40" max="200"></label>
  <label>Ceiling(Hz) <input id="ceil" type="number" value="400" min="200" max="800"></label>
  <label>Smoothing <input id="smooth" type="number" value="5" min="1" max="21" step="2"></label>
</div>

<canvas id="c" width="1200" height="260"></canvas>
<div class="row">
  <div id="now">F0: -- Hz</div>
  <small id="status">ì¤€ë¹„ ì™„ë£Œ</small>
</div>

<hr style="margin:24px 0;">

<!-- â‘¡ ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ -->
<h2>â‘¡ ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ (ëª¨ë²” ì–µì–‘ê³¼ ë¹„êµ)</h2>
<p style="font-size:14px; color:#555;">
  ë¬¸ì¥ì„ ì„ íƒí•œ ë’¤, ëª¨ë²” ë°œí™”ë¥¼ ë“£ê³ , ì—°ìŠµ ë…¹ìŒì„ í•˜ë©´
  íšŒìƒ‰ ì„ (ëª¨ë²”)ê³¼ ë¹¨ê°„ ì„ (ë‚´ ë°œí™”)ì˜ F0 ê³¡ì„ ì„ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
</p>

<div class="row">
  <button class="sent-btn" data-key="nugu_yn">ëˆ„êµ¬ ë§Œë‚˜ìš”? (íŒì •)</button>
  <button class="sent-btn" data-key="nugu_wh">ëˆ„êµ¬ ë§Œë‚˜ìš”? (ì„¤ëª…)</button>
  <button class="sent-btn" data-key="eodi_yn">ì–´ë”” ê°€ìš”? (íŒì •)</button>
  <button class="sent-btn" data-key="eodi_wh">ì–´ë”” ê°€ìš”? (ì„¤ëª…)</button>
  <button class="sent-btn" data-key="eonje_yn">ì–¸ì œ ì™€ìš”? (íŒì •)</button>
  <button class="sent-btn" data-key="eonje_wh">ì–¸ì œ ì™€ìš”? (ì„¤ëª…)</button>
  <button class="sent-btn" data-key="mwo_yn">ë­ í•´ìš”? (íŒì •)</button>
  <button class="sent-btn" data-key="mwo_wh">ë­ í•´ìš”? (ì„¤ëª…)</button>
</div>

<div class="row">
  <button id="btn-play-model">ëª¨ë²” ë°œí™” ë“£ê¸°</button>
  <button id="btn-prac-start">ì—°ìŠµ ë…¹ìŒ Start</button>
  <button id="btn-prac-stop" disabled>ì—°ìŠµ ë…¹ìŒ Stop</button>
</div>

<canvas id="cPractice" width="1200" height="260"></canvas>
<div class="row">
  <small id="practiceStatus">ì—°ìŠµí•  ë¬¸ì¥ì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.</small>
</div>

<script>
let mediaStream, mediaRecorder, chunks = [], audioCtx;
const startBtn = document.getElementById('start');
const stopBtn  = document.getElementById('stop');
const resetBtn = document.getElementById('reset');
const c  = document.getElementById('c');
const g  = c.getContext('2d');

function setStatus(t){
  document.getElementById('status').textContent = " Â· " + t;
}

async function ensureAudioContext(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === 'suspended') {
    try { await audioCtx.resume(); } catch(e){}
  }
  return audioCtx;
}

// ===== Pitch tracking (autocorrelation) =====
function hannWindow(N){
  const w = new Float32Array(N);
  for(let i=0;i<N;i++) w[i]=0.5-0.5*Math.cos(2*Math.PI*i/(N-1));
  return w;
}
const ACF_WINDOW = hannWindow(2048);

function f0_from_frame(buf, sr, floor, ceil){
  const N = buf.length;
  let mean = 0;
  for(let i=0;i<N;i++) mean += buf[i];
  mean /= N;

  let rms = 0;
  for(let i=0;i<N;i++){
    const v = (buf[i]-mean)*ACF_WINDOW[i%ACF_WINDOW.length];
    rms += v*v;
    buf[i] = v;
  }
  rms = Math.sqrt(rms/N);
  if(rms < 0.005) return 0;

  const minLag = Math.floor(sr/ceil);
  const maxLag = Math.floor(sr/floor);
  let bestLag=-1, best=0;

  let denom0=0;
  for(let i=0;i<N;i++) denom0 += buf[i]*buf[i];

  for(let lag=minLag; lag<=maxLag; lag++){
    let s=0, denom1=0;
    for(let i=0;i<N-lag;i++){
      const a=buf[i], b=buf[i+lag];
      s += a*b;
      denom1 += b*b;
    }
    const nccf = (denom1>1e-9)? s/Math.sqrt(denom0*denom1) : 0;
    if(nccf > best){ best=nccf; bestLag=lag; }
  }
  if(bestLag<0 || best<0.3) return 0;

  const ac = (lag)=>{
    let s=0;
    for(let i=0;i<N-lag;i++) s += buf[i]*buf[i+lag];
    return s;
  };
  const c1=ac(bestLag-1), c2=ac(bestLag), c3=ac(bestLag+1);
  const denom=(c1-2*c2+c3); let shift=0;
  if(Math.abs(denom)>1e-6) shift=0.5*(c1-c3)/denom;

  return sr/(bestLag+shift);
}

function medianSmooth(arr, k=5){
  if(k<2) return arr;
  const h = Math.floor(k/2), out = new Array(arr.length);
  for(let i=0;i<arr.length;i++){
    const s=Math.max(0,i-h), e=Math.min(arr.length,i+h+1);
    const slice = arr.slice(s,e).filter(v=>v>0).sort((a,b)=>a-b);
    out[i] = slice.length ? slice[Math.floor(slice.length/2)] : 0;
  }
  return out;
}

function trackPitch(signal, sr, floor, ceil, frameMs=30, hopMs=10){
  const frame = Math.round(sr*frameMs/1000);
  const hop   = Math.round(sr*hopMs/1000);
  const out = [];
  const buf = new Float32Array(frame);
  for(let start=0; start+frame<=signal.length; start+=hop){
    buf.set(signal.subarray(start,start+frame));
    out.push(f0_from_frame(buf.slice(0), sr, floor, ceil));
  }
  return out;
}

// ===== Drawing (ê³µìš©) =====
function mapF0(f,fmin,fmax){
  const clamped = Math.max(fmin,Math.min(fmax,f));
  const r = (clamped-fmin)/(fmax-fmin);
  return 244 - r*220;
}

function drawAxes(floor, ceil){
  g.clearRect(0,0,c.width,c.height);
  g.strokeStyle="#eee"; g.lineWidth=1;
  g.beginPath(); g.moveTo(48,16); g.lineTo(48,244); g.lineTo(1184,244); g.stroke();
  [floor, Math.round((floor+ceil)/2), ceil].forEach(t=>{
    const y=mapF0(t,floor,ceil);
    g.beginPath(); g.moveTo(48,y); g.lineTo(1184,y); g.stroke();
    g.fillStyle="#666"; g.font="12px system-ui"; g.fillText(t+" Hz", 8, y-2);
  });
}

function drawContour(f0s, floor, ceil, color="#0a74da"){
  drawAxes(floor, ceil);
  const n=f0s.length;
  g.strokeStyle=color; g.lineWidth=2; g.beginPath();
  let started=false;
  for(let i=0;i<n;i++){
    const f0=f0s[i]; if(f0<=0){ started=false; continue; }
    const x=48 + (i/Math.max(n-1,1))*1136;
    const y=mapF0(f0,floor,ceil);
    if(!started){ g.moveTo(x,y); started=true; } else { g.lineTo(x,y); }
  }
  g.stroke();
}

// ===== â‘  STARTâ€“STOP UI flow =====
startBtn.onclick = async () => {
  try{
    await ensureAudioContext();
    mediaStream = await navigator.mediaDevices.getUserMedia({
      audio: {channelCount:1, echoCancellation:false, noiseSuppression:false, autoGainControl:false}
    });
  }catch(e){
    alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\n(HTTPS í™˜ê²½ì—ì„œë§Œ ì‘ë™)");
    return;
  }
  chunks.length = 0;
  const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus'
             : MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4'
             : '';
  mediaRecorder = new MediaRecorder(mediaStream, mime?{mimeType:mime}:{});
  mediaRecorder.ondataavailable = (ev)=>{
    if(ev.data && ev.data.size>0) chunks.push(ev.data);
  };
  mediaRecorder.onstart = ()=> setStatus("ë…¹ìŒ ì¤‘â€¦ ë¬¸ì¥ì„ ë§í•˜ì„¸ìš”.");
  mediaRecorder.start();

  startBtn.disabled = true;
  stopBtn.disabled  = false;
  resetBtn.disabled = true;
  drawAxes(+floor.value, +ceil.value);
  document.getElementById('now').textContent = "F0: -- Hz";
};

stopBtn.onclick = async () => {
  stopBtn.disabled = true;
  if(!mediaRecorder){ return; }
  setStatus("ì²˜ë¦¬ ì¤‘â€¦(1ì´ˆ ë‚´)");
  mediaRecorder.onstop = async ()=>{
    const blob = new Blob(chunks);
    chunks.length = 0;

    const arrayBuf = await blob.arrayBuffer();
    const ctx = await ensureAudioContext();
    const audioBuf = await ctx.decodeAudioData(arrayBuf.slice(0));

    const ch = audioBuf.numberOfChannels ? audioBuf.getChannelData(0)
                                         : new Float32Array(arrayBuf.byteLength/4);
    const signal = new Float32Array(ch.length);
    let peak = 0;
    for(let i=0;i<ch.length;i++){
      const v = Math.max(-1,Math.min(1,ch[i]));
      peak = Math.max(peak,Math.abs(v));
      signal[i]=v;
    }
    if(peak>0){
      const s = 1/peak;
      for(let i=0;i<signal.length;i++) signal[i]*=s;
    }

    const floorHz = +document.getElementById('floor').value || 75;
    const ceilHz  = +document.getElementById('ceil').value  || 400;
    const f0sRaw  = trackPitch(signal, audioBuf.sampleRate, floorHz, ceilHz, 30, 17); // â˜… hop 17ms
    const k       = +document.getElementById('smooth').value;
    const f0s     = medianSmooth(f0sRaw, k);

    const last = f0s.findLast ? (f0s.findLast(v=>v>0)||0)
                              : (function(){ for(let i=f0s.length-1;i>=0;i--) if(f0s[i]>0) return f0s[i]; return 0; })();
    document.getElementById('now').textContent =
      "F0: " + (last? Math.round(last) : "--") + " Hz";

    drawContour(f0s, floorHz, ceilHz);
    setStatus("ì™„ë£Œ. ë‹¤ì‹œ ë…¹ìŒí•˜ë ¤ë©´ Reset â†’ Start");
    resetBtn.disabled = false;
  };
  mediaRecorder.stop();
  if(mediaStream){
    mediaStream.getTracks().forEach(t=>t.stop());
    mediaStream=null;
  }
};

resetBtn.onclick = ()=>{
  drawAxes(+floor.value, +ceil.value);
  document.getElementById('now').textContent = "F0: -- Hz";
  setStatus("ì¤€ë¹„ ì™„ë£Œ");
  startBtn.disabled=false;
  stopBtn.disabled=true;
  resetBtn.disabled=true;
};

// ===== â‘¡ ë¬¸ì¥ ì—°ìŠµ ëª¨ë“œ =====
const cPractice = document.getElementById('cPractice');
const gPractice = cPractice.getContext('2d');
const practiceStatusEl = document.getElementById('practiceStatus');
const btnPlayModel = document.getElementById('btn-play-model');
const btnPracStart = document.getElementById('btn-prac-start');
const btnPracStop  = document.getElementById('btn-prac-stop');
const sentBtns = document.querySelectorAll('.sent-btn');

function setPracticeStatus(t){
  if(practiceStatusEl) practiceStatusEl.textContent = t;
}

const sentenceDefs = {
  "nugu_yn":  { file: "audio/nugu_yn.wav",  label: "ëˆ„êµ¬ ë§Œë‚˜ìš”? (íŒì •)" },
  "nugu_wh":  { file: "audio/nugu_wh.wav",  label: "ëˆ„êµ¬ ë§Œë‚˜ìš”? (ì„¤ëª…)" },
  "eodi_yn":  { file: "audio/eodi_yn.wav",  label: "ì–´ë”” ê°€ìš”? (íŒì •)" },
  "eodi_wh":  { file: "audio/eodi_wh.wav",  label: "ì–´ë”” ê°€ìš”? (ì„¤ëª…)" },
  "eonje_yn": { file: "audio/eonje_yn.wav", label: "ì–¸ì œ ì™€ìš”? (íŒì •)" },
  "eonje_wh": { file: "audio/eonje_wh.wav", label: "ì–¸ì œ ì™€ìš”? (ì„¤ëª…)" },
  "mwo_yn":   { file: "audio/mwo_yn.wav",   label: "ë­ í•´ìš”? (íŒì •)" },
  "mwo_wh":   { file: "audio/mwo_wh.wav",   label: "ë­ í•´ìš”? (ì„¤ëª…)" }
};

let currentKey = null;
const sentenceBuffers = {};
let modelF0s = [];
let userF0s  = [];

function drawPracticeAxes(floor, ceil){
  gPractice.clearRect(0,0,cPractice.width,cPractice.height);
  gPractice.strokeStyle="#eee"; gPractice.lineWidth=1;
  gPractice.beginPath(); gPractice.moveTo(48,16); gPractice.lineTo(48,244); gPractice.lineTo(1184,244); gPractice.stroke();
  [floor, Math.round((floor+ceil)/2), ceil].forEach(t=>{
    const y=mapF0(t,floor,ceil);
    gPractice.beginPath(); gPractice.moveTo(48,y); gPractice.lineTo(1184,y); gPractice.stroke();
    gPractice.fillStyle="#666"; gPractice.font="12px system-ui"; gPractice.fillText(t+" Hz", 8, y-2);
  });
}

function drawPracticeSeries(f0s, color, floor, ceil){
  const n = f0s.length;
  if(!n) return;
  gPractice.strokeStyle=color; gPractice.lineWidth=2; gPractice.beginPath();
  let started=false;
  for(let i=0;i<n;i++){
    const f0=f0s[i]; if(f0<=0){ started=false; continue; }
    const x=48 + (i/Math.max(n-1,1))*1136;
    const y=mapF0(f0,floor,ceil);
    if(!started){ gPractice.moveTo(x,y); started=true; } else { gPractice.lineTo(x,y); }
  }
  gPractice.stroke();
}

function redrawPractice(){
  const floorHz = +document.getElementById('floor').value || 75;
  const ceilHz  = +document.getElementById('ceil').value  || 400;
  drawPracticeAxes(floorHz, ceilHz);
  drawPracticeSeries(modelF0s, "#888888", floorHz, ceilHz); // ëª¨ë²”: íšŒìƒ‰
  drawPracticeSeries(userF0s,  "#e65b5b", floorHz, ceilHz); // ë‚´ ë°œí™”: ë¹¨ê°•
}

async function loadSentenceBuffer(key){
  if(!sentenceDefs[key]) return null;
  if(sentenceBuffers[key]) return sentenceBuffers[key];

  const def = sentenceDefs[key];
  try{
    const resp = await fetch(def.file);
    if(!resp.ok) throw new Error("File not found");
    const arrayBuf = await resp.arrayBuffer();
    const ctx = await ensureAudioContext();
    const buffer = await ctx.decodeAudioData(arrayBuf.slice(0));
    sentenceBuffers[key] = buffer;
    return buffer;
  }catch(e){
    alert("ëª¨ë²” ë°œí™” íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: " + def.file);
    console.error(e);
    return null;
  }
}

async function updateModelF0(key){
  const buffer = await loadSentenceBuffer(key);
  if(!buffer) return;
  const data = buffer.getChannelData(0);
  const sr   = buffer.sampleRate;
  const signal = new Float32Array(data.length);
  signal.set(data);

  const floorHz = +document.getElementById('floor').value || 75;
  const ceilHz  = +document.getElementById('ceil').value  || 400;
  const raw = trackPitch(signal, sr, floorHz, ceilHz, 30, 17);
  const k   = +document.getElementById('smooth').value || 5;
  modelF0s  = medianSmooth(raw, k);
  setPracticeStatus("ëª¨ë²” ì–µì–‘ ê³¡ì„ ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ì—°ìŠµ ë…¹ìŒì„ í•´ ë³´ì„¸ìš”.");
  redrawPractice();
}

sentBtns.forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const key = btn.dataset.key;
    currentKey = key;
    sentBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    userF0s = [];
    setPracticeStatus("ëª¨ë²” ì–µì–‘ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦");
    await updateModelF0(key);
  });
});

btnPlayModel.addEventListener('click', async ()=>{
  if(!currentKey){
    alert("ë¨¼ì € ì—°ìŠµí•  ë¬¸ì¥ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
    return;
  }
  const buffer = await loadSentenceBuffer(currentKey);
  if(!buffer) return;
  const ctx = await ensureAudioContext();
  const src = ctx.createBufferSource();
  src.buffer = buffer;
  src.connect(ctx.destination);
  src.start();
});

// ì—°ìŠµ ë…¹ìŒ
let pracStream = null;
let pracRecorder = null;
let pracChunks = [];

btnPracStart.addEventListener('click', async ()=>{
  if(!currentKey){
    alert("ë¨¼ì € ì—°ìŠµí•  ë¬¸ì¥ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
    return;
  }
  if(pracRecorder) return;

  try{
    await ensureAudioContext();
    pracStream = await navigator.mediaDevices.getUserMedia({
      audio:{channelCount:1, echoCancellation:false, noiseSuppression:false, autoGainControl:false}
    });
  }catch(e){
    alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
    return;
  }

  pracChunks.length = 0;
  const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus'
             : MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4'
             : '';
  pracRecorder = new MediaRecorder(pracStream, mime?{mimeType:mime}:{});
  pracRecorder.ondataavailable = (ev)=>{
    if(ev.data && ev.data.size>0) pracChunks.push(ev.data);
  };
  pracRecorder.onstart = ()=> setPracticeStatus("ì—°ìŠµ ë…¹ìŒ ì¤‘â€¦");
  pracRecorder.start();

  btnPracStart.disabled = true;
  btnPracStop.disabled  = false;
});

btnPracStop.addEventListener('click', async ()=>{
  if(!pracRecorder) return;
  setPracticeStatus("ì—°ìŠµ ë°œí™”ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘â€¦");
  pracRecorder.onstop = async ()=>{
    const blob = new Blob(pracChunks);
    pracChunks.length = 0;
    const arrayBuf = await blob.arrayBuffer();
    const ctx = await ensureAudioContext();
    const audioBuf = await ctx.decodeAudioData(arrayBuf.slice(0));

    const ch = audioBuf.getChannelData(0);
    const signal = new Float32Array(ch.length);
    signal.set(ch);

    const floorHz = +document.getElementById('floor').value || 75;
    const ceilHz  = +document.getElementById('ceil').value  || 400;
    const raw = trackPitch(signal, audioBuf.sampleRate, floorHz, ceilHz, 30, 17);
    const k   = +document.getElementById('smooth').value || 5;
    userF0s   = medianSmooth(raw, k);
    redrawPractice();
    setPracticeStatus("ë¶„ì„ ì™„ë£Œ! íšŒìƒ‰ = ëª¨ë²”, ë¹¨ê°„ìƒ‰ = ë‚´ ë°œí™”ì…ë‹ˆë‹¤.");
  };
  pracRecorder.stop();
  if(pracStream){
    pracStream.getTracks().forEach(t=>t.stop());
    pracStream = null;
  }
  btnPracStart.disabled = false;
  btnPracStop.disabled  = true;
});

// ì´ˆê¸° ì¶• ê·¸ë¦¬ê¸°
drawAxes(+floor.value, +ceil.value);
drawPracticeAxes(+floor.value, +ceil.value);
</script>
</html>
